<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>Aqua World</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&family=Orbitron:wght@700;900&display=swap');
:root{--deep:#020e1f;--accent:#00d4ff;--accent2:#00ff9d;--gold:#ffd700;--coral:#ff6b6b;--text:#c8f0ff;}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{font-family:'Quicksand',sans-serif;background:var(--deep);color:var(--text);height:100vh;overflow:hidden;}
::-webkit-scrollbar{width:4px;}::-webkit-scrollbar-thumb{background:rgba(0,212,255,0.25);border-radius:2px;}

/* AUTH */
#authScreen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:1000;overflow-y:auto;padding:16px;}
#authScreen::before{content:'';position:absolute;inset:0;background:rgba(0,5,20,0.52);}
.auth-box{position:relative;z-index:2;background:rgba(2,12,35,0.88);border:2px solid var(--accent);border-radius:14px;padding:26px 28px;width:100%;max-width:390px;backdrop-filter:blur(18px);box-shadow:0 0 40px rgba(0,212,255,0.3),inset 0 0 24px rgba(0,212,255,0.04);clip-path:polygon(10px 0%,calc(100% - 10px) 0%,100% 10px,100% calc(100% - 10px),calc(100% - 10px) 100%,10px 100%,0% calc(100% - 10px),0% 10px);animation:fadeUp .5s ease;}
.auth-logo{text-align:center;margin-bottom:16px;}
.auth-fish-img{width:52px;filter:drop-shadow(0 0 10px var(--accent));animation:swimLogo 3s ease-in-out infinite;}
@keyframes swimLogo{0%,100%{transform:translateX(-6px) rotate(-3deg);}50%{transform:translateX(6px) rotate(3deg);}}
.auth-logo h1{font-family:'Orbitron',monospace;font-size:19px;color:var(--accent);text-shadow:0 0 18px var(--accent);letter-spacing:4px;margin-top:5px;}
.tabs{display:flex;margin-bottom:14px;border:1px solid rgba(0,212,255,0.28);border-radius:8px;overflow:hidden;}
.tab-btn{flex:1;padding:9px;border:none;background:transparent;color:rgba(200,240,255,0.4);cursor:pointer;font-family:'Quicksand',sans-serif;font-size:13px;font-weight:700;transition:all .3s;letter-spacing:1px;}
.tab-btn.active{background:rgba(0,212,255,0.18);color:var(--accent);}
.tab-btn:first-child{border-right:1px solid rgba(0,212,255,0.28);}
.auth-input{width:100%;padding:10px 13px;background:rgba(0,0,0,0.5);border:1px solid rgba(0,212,255,0.22);border-radius:8px;color:var(--text);font-family:'Quicksand',sans-serif;font-size:14px;margin-bottom:9px;outline:none;transition:border-color .3s;}
.auth-input:focus{border-color:var(--accent);}
.auth-btn{width:100%;padding:11px;background:transparent;border:1px solid var(--accent);border-radius:8px;color:var(--accent);font-family:'Quicksand',sans-serif;font-size:14px;font-weight:700;cursor:pointer;letter-spacing:2px;margin-top:3px;transition:all .3s;}
.auth-btn:hover{background:rgba(0,212,255,0.13);}
.founder-btn{width:100%;padding:9px;background:rgba(255,215,0,0.08);border:1px solid rgba(255,215,0,0.38);border-radius:8px;color:var(--gold);font-family:'Quicksand',sans-serif;font-size:13px;font-weight:700;cursor:pointer;margin-top:8px;}
.back-btn{width:100%;padding:9px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:rgba(200,240,255,0.45);font-family:'Quicksand',sans-serif;font-size:13px;cursor:pointer;margin-top:8px;}
.auth-msg{font-size:12px;text-align:center;margin-top:8px;min-height:16px;}
.auth-msg.err{color:var(--coral);}.auth-msg.ok{color:var(--accent2);}
.dev-tag{text-align:center;font-size:11px;color:rgba(200,240,255,0.18);margin-top:12px;}
/* Avatar picker */
.av-pick-title{font-size:11px;color:var(--accent);letter-spacing:1px;text-align:center;margin-bottom:7px;font-weight:700;}
.avatar-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:7px;margin-bottom:11px;}
.av-option{border:2px solid rgba(0,212,255,0.18);border-radius:50%;overflow:hidden;cursor:pointer;aspect-ratio:1;background:rgba(0,0,0,0.3);transition:all .25s;}
.av-option img{width:100%;height:100%;object-fit:cover;display:block;}
.av-option.selected,.av-option:hover{border-color:var(--accent);box-shadow:0 0 14px rgba(0,212,255,0.45);}
/* GAME */
#gameScreen{display:none;position:fixed;inset:0;}
#aquariumCanvas{position:absolute;top:0;left:0;width:100%;height:100%;cursor:crosshair;}

/* TOP BAR */
.top-bar-wrap{position:absolute;top:0;left:0;right:0;height:54px;background:linear-gradient(180deg,rgba(1,7,22,0.97),rgba(1,7,22,0.45));z-index:10;overflow:hidden;}
.top-bar{display:flex;align-items:center;padding:0 12px;gap:7px;height:54px;overflow-x:auto;overflow-y:hidden;-webkit-overflow-scrolling:touch;scrollbar-width:none;}
.top-bar::-webkit-scrollbar{display:none;}
.top-fade-l{position:absolute;left:0;top:0;width:22px;height:54px;background:linear-gradient(90deg,rgba(1,7,22,.97),transparent);pointer-events:none;z-index:1;}
.top-fade-r{position:absolute;right:0;top:0;width:22px;height:54px;background:linear-gradient(270deg,rgba(1,7,22,.97),transparent);pointer-events:none;z-index:1;}
.top-title{font-family:'Orbitron',monospace;font-size:12px;color:var(--accent);text-shadow:0 0 12px var(--accent);letter-spacing:2px;flex-shrink:0;}
.user-pill{display:flex;align-items:center;gap:7px;background:rgba(0,0,0,0.45);border:1px solid rgba(0,212,255,0.18);border-radius:20px;padding:3px 11px 3px 3px;flex-shrink:0;cursor:pointer;transition:border-color .2s;}
.user-pill:hover{border-color:var(--accent);}
.user-av{width:30px;height:30px;border-radius:50%;border:1px solid var(--accent);object-fit:cover;}
.user-name{font-size:12px;font-weight:700;}
.badge-owner{background:linear-gradient(135deg,var(--gold),#c06000);color:#000;font-size:10px;font-weight:700;padding:2px 6px;border-radius:9px;}
.badge-dev{background:linear-gradient(135deg,#f0f,#70c);color:#fff;font-size:10px;font-weight:700;padding:2px 6px;border-radius:9px;}
.coin-pill{display:flex;align-items:center;gap:5px;background:rgba(0,0,0,0.45);border:1px solid rgba(255,215,0,0.2);border-radius:20px;padding:5px 11px;font-size:13px;font-weight:700;color:var(--gold);flex-shrink:0;}
.level-pill{display:flex;align-items:center;gap:5px;background:rgba(0,0,0,0.45);border:1px solid rgba(0,255,157,0.2);border-radius:20px;padding:5px 11px;font-size:12px;font-weight:700;color:var(--accent2);flex-shrink:0;}
.top-gap{flex:1;min-width:6px;}
.top-btn{background:rgba(0,0,0,0.4);border:1px solid rgba(0,212,255,0.2);border-radius:18px;padding:6px 12px;color:var(--text);cursor:pointer;font-family:'Quicksand',sans-serif;font-size:11px;font-weight:700;flex-shrink:0;transition:all .25s;white-space:nowrap;}
.top-btn:hover{border-color:var(--accent);color:var(--accent);}
.shop-btn{background:linear-gradient(135deg,rgba(0,212,255,0.2),rgba(0,212,255,0.06));border:1px solid rgba(0,212,255,0.35);border-radius:18px;padding:6px 15px;color:var(--accent);cursor:pointer;font-family:'Quicksand',sans-serif;font-size:11px;font-weight:700;flex-shrink:0;}
.quest-btn{background:linear-gradient(135deg,rgba(255,215,0,0.18),rgba(255,140,0,0.08));border:1px solid rgba(255,215,0,0.32);border-radius:18px;padding:6px 13px;color:var(--gold);cursor:pointer;font-family:'Quicksand',sans-serif;font-size:11px;font-weight:700;flex-shrink:0;}

/* SIDE PANEL */
.side-panel{position:absolute;right:0;top:54px;bottom:0;width:238px;background:linear-gradient(180deg,rgba(1,8,26,.98),rgba(1,4,14,.99));border-left:1px solid rgba(0,212,255,0.07);z-index:10;display:flex;flex-direction:column;overflow-y:auto;padding:10px;gap:9px;}
@media(max-width:680px){.side-panel{display:none;}}
.ps{background:rgba(0,0,0,0.28);border:1px solid rgba(0,212,255,0.08);border-radius:11px;padding:10px;}
.ps-title{font-size:10px;font-weight:700;color:var(--accent);letter-spacing:2px;margin-bottom:7px;text-transform:uppercase;}
.fish-row{display:flex;align-items:center;gap:6px;padding:4px 6px;border-radius:7px;background:rgba(0,0,0,0.2);margin-bottom:3px;font-size:11px;}
.hunger-bar{flex:1;height:4px;background:rgba(255,255,255,0.07);border-radius:2px;overflow:hidden;}
.hunger-fill{height:100%;border-radius:2px;transition:width .5s;}
.badge-chip{display:inline-flex;align-items:center;gap:3px;background:rgba(0,0,0,0.28);border:1px solid rgba(255,215,0,0.18);border-radius:18px;padding:2px 7px;font-size:10px;margin:2px;color:var(--gold);}
.xp-bar-wrap{background:rgba(0,0,0,0.28);border-radius:3px;height:5px;margin-top:5px;overflow:hidden;}
.xp-bar-fill{height:100%;background:linear-gradient(90deg,var(--accent2),var(--accent));border-radius:3px;transition:width .6s;}
.xp-label{font-size:10px;color:rgba(200,240,255,0.38);margin-top:3px;}
.weather-row{display:flex;align-items:center;gap:7px;padding:6px 8px;background:rgba(0,0,0,0.18);border-radius:8px;font-size:11px;}
.no-content{font-size:11px;color:rgba(200,240,255,0.28);}
  /* OVERLAYS */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:200;display:none;align-items:center;justify-content:center;backdrop-filter:blur(6px);padding:14px;}
.overlay.open{display:flex;}
.modal{background:linear-gradient(145deg,#040f28,#020918);border-radius:20px;width:100%;max-height:92vh;overflow:hidden;display:flex;flex-direction:column;animation:fadeUp .35s ease;}
.modal-hdr{display:flex;align-items:center;padding:16px 20px 11px;border-bottom:1px solid rgba(0,212,255,0.07);flex-shrink:0;}
.modal-hdr h2{font-family:'Orbitron',monospace;font-size:13px;letter-spacing:2px;flex:1;}
.modal-x{background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:50%;width:30px;height:30px;color:var(--text);cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .2s;}
.modal-x:hover{background:rgba(255,80,80,0.2);color:var(--coral);}
.modal-body{flex:1;overflow-y:auto;padding:13px 20px 20px;}

/* SHOP */
#shopModal{border:1px solid rgba(0,212,255,0.2);max-width:760px;}
.shop-coins{font-size:13px;font-weight:700;color:var(--gold);margin-right:12px;}
.shop-cats{display:flex;gap:6px;padding:9px 20px 0;flex-shrink:0;overflow-x:auto;}
.cat-btn{padding:7px 15px;border-radius:18px;border:1px solid rgba(0,212,255,0.16);background:transparent;color:rgba(200,240,255,0.42);cursor:pointer;font-family:'Quicksand',sans-serif;font-size:12px;font-weight:700;flex-shrink:0;transition:all .25s;}
.cat-btn.active{background:rgba(0,212,255,0.14);border-color:var(--accent);color:var(--accent);}
.shop-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(155px,1fr));gap:10px;padding-top:11px;}
.shop-card{background:rgba(0,0,0,0.32);border:1px solid rgba(0,212,255,0.1);border-radius:13px;padding:13px 10px;text-align:center;transition:all .25s;position:relative;overflow:hidden;}
.shop-card::before{content:'';position:absolute;inset:0;background:radial-gradient(circle at 50% 0%,rgba(0,212,255,0.06) 0%,transparent 70%);opacity:0;transition:opacity .25s;}
.shop-card:hover:not(.locked){border-color:rgba(0,212,255,0.28);transform:translateY(-2px);}
.shop-card:hover:not(.locked)::before{opacity:1;}
.shop-card.rare{border-color:rgba(255,215,0,0.2);}
.shop-card.rare::after{content:'‚òÖ NADƒ∞R';position:absolute;top:7px;right:7px;font-size:9px;color:var(--gold);font-weight:700;}
.shop-card.epic{border-color:rgba(180,0,255,0.25);}
.shop-card.epic::after{content:'‚óÜ EPƒ∞K';position:absolute;top:7px;right:7px;font-size:9px;color:#cc88ff;font-weight:700;}
.shop-card.locked{opacity:.48;filter:grayscale(.5);}
.sc-icon{font-size:38px;display:block;margin-bottom:6px;line-height:1;}
.sc-name{font-size:12px;font-weight:700;margin-bottom:2px;}
.sc-desc{font-size:10px;color:rgba(200,240,255,0.38);margin-bottom:5px;line-height:1.4;}
.sc-speed{font-size:10px;color:rgba(200,240,255,0.26);margin-bottom:4px;}
.sc-price{font-size:13px;font-weight:700;color:var(--gold);margin-bottom:8px;}
.sc-req{font-size:10px;color:rgba(255,180,0,0.55);margin-bottom:4px;}
.card-btn{width:100%;padding:7px;background:linear-gradient(135deg,rgba(0,212,255,0.16),rgba(0,212,255,0.06));border:1px solid rgba(0,212,255,0.25);border-radius:8px;color:var(--accent);font-family:'Quicksand',sans-serif;font-size:12px;font-weight:700;cursor:pointer;transition:all .22s;}
.card-btn:hover:not([disabled]){background:linear-gradient(135deg,rgba(0,212,255,0.3),rgba(0,212,255,0.14));}
.card-btn.owned{opacity:.42;cursor:default;background:rgba(0,255,157,0.07);border-color:rgba(0,255,157,0.28);color:var(--accent2);}
.card-btn[disabled]{opacity:.38;cursor:not-allowed;}

/* QUESTS */
#questModal{border:1px solid rgba(255,215,0,0.22);max-width:510px;}
.section-title{font-size:10px;font-weight:700;color:var(--gold);letter-spacing:2px;text-transform:uppercase;margin-bottom:8px;margin-top:4px;}
.gift-card{background:linear-gradient(135deg,rgba(255,215,0,0.1),rgba(255,140,0,0.05));border:1px solid rgba(255,215,0,0.3);border-radius:12px;padding:12px;margin-bottom:9px;display:flex;align-items:flex-start;gap:10px;animation:giftPulse 2.5s ease-in-out infinite;}
@keyframes giftPulse{0%,100%{box-shadow:0 0 0 rgba(255,215,0,0);}50%{box-shadow:0 0 16px rgba(255,215,0,0.2);}}
.gift-icon{font-size:24px;flex-shrink:0;}
.gift-info{flex:1;}
.gift-title{font-size:12px;font-weight:700;color:var(--gold);margin-bottom:3px;}
.gift-msg{font-size:11px;color:rgba(200,240,255,0.55);line-height:1.5;}
.gift-claim-btn{background:linear-gradient(135deg,var(--gold),#cc8800);color:#000;border:none;padding:6px 13px;border-radius:16px;font-family:'Quicksand',sans-serif;font-size:11px;font-weight:700;cursor:pointer;margin-top:7px;display:block;}
.quest-card{background:rgba(0,0,0,0.3);border:1px solid rgba(255,215,0,0.1);border-radius:12px;padding:12px;margin-bottom:8px;display:flex;align-items:flex-start;gap:10px;}
.quest-card.claimed{border-color:rgba(0,255,157,0.25);background:rgba(0,255,157,0.03);}
.quest-icon{font-size:24px;flex-shrink:0;margin-top:2px;}
.quest-info{flex:1;}
.quest-name{font-size:13px;font-weight:700;margin-bottom:2px;}
.quest-desc{font-size:11px;color:rgba(200,240,255,0.4);}
.quest-prog-wrap{background:rgba(0,0,0,0.28);border-radius:3px;height:4px;margin-top:5px;overflow:hidden;}
.quest-prog-fill{height:100%;background:linear-gradient(90deg,var(--gold),#ff8800);border-radius:3px;transition:width .5s;}
.quest-prog-text{font-size:10px;color:rgba(200,240,255,0.3);margin-top:2px;}
.quest-reward{font-size:12px;font-weight:700;color:var(--gold);flex-shrink:0;}
.quest-claim-btn{background:linear-gradient(135deg,var(--gold),#cc8800);color:#000;border:none;padding:6px 12px;border-radius:15px;font-family:'Quicksand',sans-serif;font-size:11px;font-weight:700;cursor:pointer;margin-top:5px;display:block;}
.quest-done-lbl{font-size:11px;color:var(--accent2);margin-top:4px;}
.quest-timer{font-size:11px;color:rgba(200,240,255,0.32);text-align:center;padding:8px 0;}
/* PROFILE */
#profileModal{border:1px solid rgba(0,212,255,0.2);max-width:400px;}
.profile-av-big{width:110px;height:110px;border-radius:50%;border:3px solid var(--accent);object-fit:cover;display:block;margin:0 auto 12px;box-shadow:0 0 26px rgba(0,212,255,0.28);}
.profile-username{text-align:center;font-family:'Orbitron',monospace;font-size:15px;color:var(--accent);letter-spacing:2px;margin-bottom:3px;}
.profile-level{text-align:center;font-size:12px;color:var(--accent2);margin-bottom:13px;}
.profile-stats{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:13px;}
.stat-box{background:rgba(0,0,0,0.28);border:1px solid rgba(0,212,255,0.1);border-radius:9px;padding:9px;text-align:center;}
.stat-val{font-size:17px;font-weight:700;color:var(--accent);}
.stat-lbl{font-size:10px;color:rgba(200,240,255,0.38);margin-top:2px;}
.profile-sec{font-size:10px;font-weight:700;color:var(--gold);letter-spacing:2px;text-transform:uppercase;margin-bottom:7px;}
.profile-badges{display:flex;flex-wrap:wrap;gap:5px;}
.pb-item{display:flex;align-items:center;gap:4px;background:rgba(0,0,0,0.28);border:1px solid rgba(255,215,0,0.18);border-radius:16px;padding:4px 9px;font-size:11px;color:var(--gold);}

/* OWNER */
#ownerModal{border:2px solid var(--gold);max-width:490px;}
.owner-tabs{display:flex;gap:4px;margin-bottom:13px;background:rgba(0,0,0,0.32);border-radius:9px;padding:4px;}
.owner-tab{flex:1;padding:7px;border:none;border-radius:6px;background:transparent;color:rgba(200,240,255,0.38);cursor:pointer;font-family:'Quicksand',sans-serif;font-size:11px;font-weight:700;transition:all .25s;}
.owner-tab.active{background:rgba(255,215,0,0.14);color:var(--gold);}
.u-row{background:rgba(0,0,0,0.28);border:1px solid rgba(255,215,0,0.1);border-radius:10px;padding:10px;margin-bottom:7px;}
.u-row-top{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
.u-av{width:36px;height:36px;border-radius:50%;border:1px solid rgba(255,215,0,0.35);object-fit:cover;}
.u-info{flex:1;}
.u-name{font-size:13px;font-weight:700;}
.u-stats{font-size:10px;color:rgba(200,240,255,0.38);}
.o-select{background:rgba(0,0,0,0.38);border:1px solid rgba(255,215,0,0.18);border-radius:8px;color:var(--gold);padding:8px;font-family:'Quicksand',sans-serif;font-size:12px;width:100%;margin-bottom:7px;outline:none;}
.o-input{width:100%;padding:9px 12px;background:rgba(0,0,0,0.38);border:1px solid rgba(255,215,0,0.18);border-radius:8px;color:var(--text);font-family:'Quicksand',sans-serif;font-size:12px;margin-bottom:7px;outline:none;}
.o-input:focus,.o-select:focus{border-color:var(--gold);}
.o-btn{padding:7px 14px;border-radius:8px;border:1px solid;font-family:'Quicksand',sans-serif;font-size:11px;font-weight:700;cursor:pointer;transition:all .2s;}
.o-btn-gold{border-color:var(--gold);color:var(--gold);background:rgba(255,215,0,0.08);}.o-btn-gold:hover{background:rgba(255,215,0,0.18);}
.o-btn-green{border-color:var(--accent2);color:var(--accent2);background:rgba(0,255,157,0.07);}.o-btn-green:hover{background:rgba(0,255,157,0.14);}
</style>
</head>
<body>
  <!-- AUTH SCREEN -->
<div id="authScreen">
  <div class="auth-box">
    <div class="auth-logo">
      <img class="auth-fish-img" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%2300d4ff' opacity='.2'/%3E%3Ctext x='50' y='70' font-size='60' text-anchor='middle' fill='%2300d4ff'%3Eüê†%3C/text%3E%3C/svg%3E" alt="">
      <h1>AQUA WORLD</h1>
    </div>
    
    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('login')">Gƒ∞Rƒ∞≈û</button>
      <button class="tab-btn" onclick="switchTab('register')">KAYIT</button>
    </div>

    <!-- LOGIN FORM -->
    <div id="loginForm">
      <input class="auth-input" id="lUser" placeholder="Kullanƒ±cƒ± adƒ±" type="text">
      <input class="auth-input" id="lPass" placeholder="≈ûifre" type="password">
      <button class="auth-btn" onclick="doLogin()">Gƒ∞Rƒ∞≈û YAP</button>
      <button class="founder-btn" onclick="showFounder()">üëë Kurucu Giri≈üi</button>
    </div>

    <!-- REGISTER FORM -->
    <div id="registerForm" style="display:none">
      <div class="av-pick-title">AVATAR SE√á</div>
      <div class="avatar-grid">
        <div class="av-option selected" data-av="nemo" onclick="pickAv(this)"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%23ff5500'/%3E%3Ctext x='50' y='70' font-size='50' text-anchor='middle' fill='white'%3Eüêü%3C/text%3E%3C/svg%3E"></div>
        <div class="av-option" data-av="shark" onclick="pickAv(this)"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%234444ff'/%3E%3Ctext x='50' y='70' font-size='50' text-anchor='middle' fill='white'%3Eü¶à%3C/text%3E%3C/svg%3E"></div>
        <div class="av-option" data-av="puffer" onclick="pickAv(this)"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%23ffaa00'/%3E%3Ctext x='50' y='70' font-size='50' text-anchor='middle' fill='white'%3Eüê°%3C/text%3E%3C/svg%3E"></div>
        <div class="av-option" data-av="jellyfish" onclick="pickAv(this)"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%23ff77aa'/%3E%3Ctext x='50' y='70' font-size='50' text-anchor='middle' fill='white'%3Eüêô%3C/text%3E%3C/svg%3E"></div>
        <div class="av-option" data-av="seahorse" onclick="pickAv(this)"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%2300aa88'/%3E%3Ctext x='50' y='70' font-size='50' text-anchor='middle' fill='white'%3Eüêâ%3C/text%3E%3C/svg%3E"></div>
        <div class="av-option" data-av="dolphin" onclick="pickAv(this)"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%233399ff'/%3E%3Ctext x='50' y='70' font-size='50' text-anchor='middle' fill='white'%3Eüê¨%3C/text%3E%3C/svg%3E"></div>
      </div>
      <input class="auth-input" id="rUser" placeholder="Kullanƒ±cƒ± adƒ±" type="text">
      <input class="auth-input" id="rPass" placeholder="≈ûifre" type="password">
      <input class="auth-input" id="rPass2" placeholder="≈ûifre tekrar" type="password">
      <button class="auth-btn" onclick="doRegister()">KAYIT OL</button>
    </div>

    <!-- FOUNDER FORM -->
    <div id="founderForm" style="display:none">
      <input class="auth-input" id="fPass" placeholder="Kurucu ≈üifresi" type="password">
      <button class="auth-btn" onclick="doFounderLogin()">Gƒ∞Rƒ∞≈û</button>
      <button class="back-btn" onclick="hideFounder()">‚Üê Geri</button>
    </div>

    <div id="authMsg" class="auth-msg"></div>
    <div class="dev-tag">üêü herkese a√ßƒ±k beta</div>
  </div>
</div>
  <!-- GAME SCREEN -->
<div id="gameScreen">
  <canvas id="aquariumCanvas"></canvas>
  
  <!-- TOP BAR -->
  <div class="top-bar-wrap">
    <div class="top-fade-l"></div>
    <div class="top-fade-r"></div>
    <div class="top-bar">
      <span class="top-title">üåä AQUA</span>
      <div class="user-pill" onclick="openProfile()">
        <img class="user-av" id="tAvatar" src="" alt>
        <span class="user-name" id="tUser">misafir</span>
        <span class="badge-owner" id="tOwner" style="display:none">üëë</span>
        <span class="badge-dev" id="tDev" style="display:none">‚ö°</span>
      </div>
      <div class="coin-pill" id="tCoins">üí∞ 0</div>
      <div class="level-pill" id="tLevel">‚≠ê 1</div>
      <div class="top-gap"></div>
      <button class="shop-btn" onclick="openShop()">üõí D√ºkkan</button>
      <button class="quest-btn" onclick="openQuests()">üìã G√∂revler</button>
      <button class="top-btn" id="ownerBtn" onclick="openOwner()" style="display:none">üëë Y√∂net</button>
      <button class="top-btn" onclick="doLogout()">üö™ √áƒ±kƒ±≈ü</button>
    </div>

  <!-- SIDE PANEL -->
  <div class="side-panel">
    <div class="ps">
      <div class="ps-title">üê† BALIKLARIM</div>
      <div id="sFishList"></div>
    </div>
    <div class="ps">
      <div class="ps-title">üèÜ SEVƒ∞YE</div>
      <div style="margin-bottom:6px"><span id="sLevel">1</span> ¬∑ <span id="sLevelName">Acemi</span></div>
      <div class="xp-bar-wrap"><div class="xp-bar-fill" id="xpBar" style="width:0%"></div></div>
      <div class="xp-label" id="xpLabel">0 XP</div>
    </div>
    <div class="ps">
      <div class="ps-title">üå§ HAVA</div>
      <div class="weather-row"><span id="weatherIcon">‚òÄÔ∏è</span><span id="weatherName">A√ßƒ±k</span></div>
      <div class="weather-row" style="font-size:10px" id="weatherDesc">Sakin deniz</div>
    </div>
    <div class="ps">
      <div class="ps-title">üèÖ ROZETLER</div>
      <div id="sBadges"></div>
    </div>
  </div>
</div>
  <!-- SHOP OVERLAY -->
<div id="shopOverlay" class="overlay" onclick="oClick(event,'shopOverlay')">
  <div class="modal" id="shopModal">
    <div class="modal-hdr">
      <h2>üõí D√úKKAN</h2>
      <span style="flex:1"></span>
      <span class="shop-coins" id="shopCoins">üí∞ 0</span>
      <span class="modal-x" onclick="closeM('shopOverlay')">‚úï</span>
    </div>
    <div class="shop-cats">
      <button class="cat-btn active" onclick="setCat('fish')">üêü BALIKLAR</button>
      <button class="cat-btn" onclick="setCat('decor')">üåø DEKOR</button>
      <button class="cat-btn" onclick="setCat('special')">‚ú® √ñZEL</button>
    </div>
    <div class="modal-body" id="shopGrid"></div>
  </div>
</div>

<!-- QUESTS OVERLAY -->
<div id="questOverlay" class="overlay" onclick="oClick(event,'questOverlay')">
  <div class="modal" id="questModal">
    <div class="modal-hdr">
      <h2>üìã G√ñREVLER</h2>
      <span class="modal-x" onclick="closeM('questOverlay')">‚úï</span>
    </div>
    <div class="modal-body">
      <div id="giftSection"></div>
      <div id="questList"></div>
      <div class="quest-timer" id="questTimer"></div>
    </div>
  </div>
</div>

<!-- PROFILE OVERLAY -->
<div id="profileOverlay" class="overlay" onclick="oClick(event,'profileOverlay')">
  <div class="modal" id="profileModal">
    <div class="modal-hdr">
      <h2>üë§ PROFƒ∞L</h2>
      <span class="modal-x" onclick="closeM('profileOverlay')">‚úï</span>
    </div>
    <div class="modal-body" id="profileBody"></div>
  </div>
</div>

<!-- OWNER OVERLAY -->
<div id="ownerOverlay" class="overlay" onclick="oClick(event,'ownerOverlay')">
  <div class="modal" id="ownerModal">
    <div class="modal-hdr">
      <h2>üëë Y√ñNETƒ∞Cƒ∞ PANELƒ∞</h2>
      <span class="modal-x" onclick="closeM('ownerOverlay')">‚úï</span>
    </div>
    <div class="owner-tabs">
      <button class="owner-tab active" onclick="oTab('badge')">üèÖ ROZET</button>
      <button class="owner-tab" onclick="oTab('coin')">üí∞ COIN</button>
      <button class="owner-tab" onclick="oTab('item')">üéÅ ITEM</button>
    </div>
    <div class="modal-body" id="ownerContent"></div>
  </div>
</div>
 <script>
// ==================== DATA ====================
const OWN_U = "kurucu";
const OWN_P = "osinefe17";
const AVATARS = {
  nemo: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%23ff5500'/%3E%3Ctext x='50' y='70' font-size='50' text-anchor='middle' fill='white'%3Eüêü%3C/text%3E%3C/svg%3E",
  shark: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%234444ff'/%3E%3Ctext x='50' y='70' font-size='50' text-anchor='middle' fill='white'%3Eü¶à%3C/text%3E%3C/svg%3E",
  puffer: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%23ffaa00'/%3E%3Ctext x='50' y='70' font-size='50' text-anchor='middle' fill='white'%3Eüê°%3C/text%3E%3C/svg%3E",
  jellyfish: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%23ff77aa'/%3E%3Ctext x='50' y='70' font-size='50' text-anchor='middle' fill='white'%3Eüêô%3C/text%3E%3C/svg%3E",
  seahorse: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%2300aa88'/%3E%3Ctext x='50' y='70' font-size='50' text-anchor='middle' fill='white'%3Eüêâ%3C/text%3E%3C/svg%3E",
  dolphin: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%233399ff'/%3E%3Ctext x='50' y='70' font-size='50' text-anchor='middle' fill='white'%3Eüê¨%3C/text%3E%3C/svg%3E",
  founder: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%23ffd700'/%3E%3Ctext x='50' y='70' font-size='50' text-anchor='middle' fill='black'%3Eüëë%3C/text%3E%3C/svg%3E"
};

const WX = [
  {name:"A√ßƒ±k",icon:"‚òÄÔ∏è",desc:"Sakin deniz",cm:1,sm:1},
  {name:"Yaƒümurlu",icon:"üåßÔ∏è",desc:"Hafif dalga",cm:1.3,sm:1.2},
  {name:"Fƒ±rtƒ±nalƒ±",icon:"üå™Ô∏è",desc:"Balƒ±klar hƒ±zlƒ±",cm:1.8,sm:2.5},
  {name:"Gece",icon:"üåô",desc:"Lo≈ü ƒ±≈üƒ±k",cm:0.8,sm:1.1},
  {name:"Karlƒ±",icon:"‚ùÑÔ∏è",desc:"Sakin ama soƒüuk",cm:0.7,sm:0.9}
];

const LVL = [
  {l:1,n:"Acemi",xp:0},
  {l:2,n:"√á√∂mez",xp:80},
  {l:3,n:"Balƒ±k√ßƒ±",xp:200},
  {l:4,n:"Denizci",xp:450},
  {l:5,n:"Kaptan",xp:850},
  {l:6,n:"Amiral",xp:1500},
  {l:7,n:"Efsane",xp:2500}
];

const BADGES = [
  {id:"first_fish",icon:"üêü",name:"ƒ∞lk Balƒ±k",desc:"ƒ∞lk balƒ±ƒüƒ±nƒ± aldƒ±n",auto:true},
  {id:"beta",icon:"‚ö°",name:"Beta",desc:"13 balƒ±k",auto:true},
  {id:"master",icon:"üèÜ",name:"Balƒ±k Ustasƒ±",desc:"20 balƒ±k",auto:true},
  {id:"rich",icon:"üí∞",name:"Zengin",desc:"1000 coin",auto:true},
  {id:"collector",icon:"üìö",name:"Koleksiyoncu",desc:"8 farklƒ± t√ºr",auto:true},
  {id:"max_level",icon:"‚≠ê",name:"Zirve",desc:"Seviye 7",auto:true},
  {id:"quest_hero",icon:"üìã",name:"G√∂rev Kahramanƒ±",desc:"10 g√∂rev",auto:true},
  {id:"special_dev",icon:"‚öôÔ∏è",name:"Geli≈ütirici",desc:"√ñzel rozet",auto:false},
  {id:"vip_gold",icon:"üëë",name:"VIP Altƒ±n",desc:"√ñzel rozet",auto:false}
];

const FP = {
  normal:{spd:0.9,sz:1},
  nemo:{spd:1.3,sz:1.2},
  shark:{spd:0.7,sz:1.8},
  puffer:{spd:0.4,sz:1.1},
  jellyfish:{spd:0.8,sz:1.3},
  seahorse:{spd:0.3,sz:0.9},
  dolphin:{spd:2.0,sz:1.5},
  turtle:{spd:0.2,sz:1.4},
  eel:{spd:1.6,sz:1.3}
};

const QDEFS = [
  {id:"q1",icon:"üçï",name:"Yemek Saati",desc:"Balƒ±klarƒ±nƒ± 10 kere besle",stat:"feedCount",goal:10,reward:70},
  {id:"q2",icon:"üõí",name:"Alƒ±≈üveri≈ükolik",desc:"5 √ºr√ºn satƒ±n al",stat:"buyCount",goal:5,reward:120},
  {id:"q3",icon:"üéç",name:"Dekorat√∂r",desc:"3 dekor ekle",stat:"decorCount",goal:3,reward:80},
  {id:"q4",icon:"‚≠ê",name:"Seviye Atlama",desc:"Seviye 3'e ula≈ü",stat:"level",goal:3,reward:200},
  {id:"q5",icon:"üê†",name:"B√ºy√ºk Aile",desc:"8 balƒ±ƒüa ula≈ü",stat:"fishCount",goal:8,reward:180}
];

const SHOP = {
  fish:[
    {id:"nemo",name:"Palya√ßo Balƒ±ƒüƒ±",emoji:"üê†",desc:"Renkli ve hƒ±zlƒ±",price:120,minLvl:1,speed:"‚ö°‚ö°",rarity:""},
    {id:"shark",name:"K√∂pekbalƒ±ƒüƒ±",emoji:"ü¶à",desc:"Kocaman ve yava≈ü",price:400,minLvl:4,speed:"‚ö°",rarity:"rare"},
    {id:"puffer",name:"Kirpi Balƒ±ƒüƒ±",emoji:"üê°",desc:"≈ûi≈üer, tatlƒ±",price:200,minLvl:2,speed:"‚ö°",rarity:""},
    {id:"jellyfish",name:"Denizanasƒ±",emoji:"üéê",desc:"Zarif",price:250,minLvl:2,speed:"‚ö°‚ö°",rarity:""},
    {id:"seahorse",name:"Denizatƒ±",emoji:"üêâ",desc:"K√º√ß√ºk ama ≈üirin",price:180,minLvl:1,speed:"‚ö°",rarity:""},
    {id:"dolphin",name:"Yunus",emoji:"üê¨",desc:"√áok hƒ±zlƒ±",price:350,minLvl:3,speed:"‚ö°‚ö°‚ö°",rarity:"rare"},
    {id:"turtle",name:"Deniz Kaplumbaƒüasƒ±",emoji:"üê¢",desc:"√áok yava≈ü, sevimli",price:280,minLvl:3,speed:"‚ö°",rarity:""},
    {id:"eel",name:"M√ºren Balƒ±ƒüƒ±",emoji:"üêç",desc:"Uzun ve hƒ±zlƒ±",price:320,minLvl:4,speed:"‚ö°‚ö°‚ö°",rarity:"epic"}
  ],
  decor:[
    {id:"rock",name:"Kaya",emoji:"ü™®",desc:"Sade kaya",price:50},
    {id:"plant",name:"Deniz Yosunu",emoji:"üåø",desc:"Sallanan yosun",price:70},
    {id:"coral",name:"Mercan",emoji:"ü™∏",desc:"Renkli mercan",price:120,rarity:"rare"},
    {id:"chest",name:"Hazine Sandƒ±ƒüƒ±",emoji:"üì¶",desc:"Gizemli sandƒ±k",price:200,rarity:"rare"},
    {id:"castle",name:"Kale",emoji:"üè∞",desc:"K√º√ß√ºk sualtƒ± kalesi",price:350,rarity:"epic"}
  ],
  special:[
    {id:"sp_feed",name:"Otomatik Yemlik",emoji:"‚öôÔ∏è",desc:"30 sn'de bir otomatik besler",price:500},
    {id:"sp_magnet",name:"Mƒ±knatƒ±s",emoji:"üß≤",desc:"%100 daha fazla coin",price:400},
    {id:"sp_double",name:"√áifte XP",emoji:"‚ú®",desc:"Kazanƒ±lan XP 2 kat",price:600,rarity:"rare"},
    {id:"sp_light",name:"Renkli I≈üƒ±k",emoji:"üåà",desc:"Akvaryum renklenir",price:300},
    {id:"sp_storm",name:"Fƒ±rtƒ±na √áaƒüƒ±rma",emoji:"üå™Ô∏è",desc:"Her zaman fƒ±rtƒ±nalƒ±",price:550,rarity:"epic"}
  ]
};
// ==================== STATE ====================
let me=null,isOwner=false,animId=null,tickId=null,autoFeedId=null,wxId=null;
let curCat="fish",selAv="nemo",curOTab="badge";
let sp={},colorLight=false,storm=false,wx=WX[0];

// ==================== STORAGE ====================
const S={
  all:()=>JSON.parse(localStorage.getItem("aqw8_u")||"{}"),
  save:u=>localStorage.setItem("aqw8_u",JSON.stringify(u)),
  get:n=>{const u=S.all();return u[n]||null;},
  set:(n,d)=>{const u=S.all();u[n]=d;S.save(u);},
};

function fresh(){return{coins:200,fish:[],decors:[],badges:[],specials:[],fishCtr:0,password:"",xp:0,level:1,avatar:"nemo",quests:{},qs:{feedCount:0,buyCount:0,decorCount:0,loginCount:0,coinsNow:200,level:1,fishCount:0},lastQD:"",qDone:0,gifts:[]};}

function fix(d){
  // FIXED: parse coins as number
  if(isOwner){d.coins=999999999;}
  else{d.coins=Number(d.coins)||0;}
  d.xp=parseInt(d.xp)||0;
  d.level=parseInt(d.level)||1;
  if(!Array.isArray(d.fish))d.fish=[];
  if(!Array.isArray(d.decors))d.decors=[];
  if(!Array.isArray(d.badges))d.badges=[];
  if(!Array.isArray(d.specials))d.specials=[];
  if(!d.fishCtr)d.fishCtr=0;
  if(!d.avatar)d.avatar="nemo";
  if(!d.quests)d.quests={};
  if(!d.qDone)d.qDone=0;
  if(!Array.isArray(d.gifts))d.gifts=[];
  if(!d.qs)d.qs={feedCount:0,buyCount:0,decorCount:0,loginCount:0,coinsNow:0,level:1,fishCount:0};
  return d;
}

function today(){const n=new Date();return`${n.getFullYear()}-${n.getMonth()}-${n.getDate()}`;}

function initQ(d){
  if(d.lastQD!==today()){
    const s=[...QDEFS].sort(()=>Math.random()-.5).slice(0,5);
    d.quests={};s.forEach(q=>{d.quests[q.id]={prog:0,claimed:false};});
    d.lastQD=today();d.qs.feedCount=0;d.qs.buyCount=0;d.qs.decorCount=0;d.qs.loginCount=1;
  }else{d.qs.loginCount=Math.max(1,d.qs.loginCount||0);}
  return d;
}

// ==================== AUTH ====================
function switchTab(t){
  document.querySelectorAll(".tab-btn").forEach((b,i)=>b.classList.toggle("active",i===(t==="login"?0:1)));
  document.getElementById("loginForm").style.display=t==="login"?"":"none";
  document.getElementById("registerForm").style.display=t==="register"?"":"none";
  document.getElementById("founderForm").style.display="none";
  setMsg("");
}
function showFounder(){document.getElementById("loginForm").style.display="none";document.getElementById("founderForm").style.display="";}
function hideFounder(){document.getElementById("loginForm").style.display="";document.getElementById("founderForm").style.display="none";}
function setMsg(t,ok){const e=document.getElementById("authMsg");e.textContent=t;e.className="auth-msg "+(ok?"ok":"err");}
function pickAv(el){document.querySelectorAll(".av-option").forEach(a=>a.classList.remove("selected"));el.classList.add("selected");selAv=el.dataset.av;}

function doLogin(){
  const un=document.getElementById("lUser").value.trim();
  const pw=document.getElementById("lPass").value;
  if(!un||!pw)return setMsg("T√ºm alanlarƒ± doldur!");
  const d=S.get(un);
  if(!d)return setMsg("Kullanƒ±cƒ± bulunamadƒ±!");
  if(d.password!==btoa(pw))return setMsg("≈ûifre yanlƒ±≈ü!");
  startGame(un,false);
}
function doFounderLogin(){
  const pw=document.getElementById("fPass").value;
  if(pw!==OWN_P)return setMsg("Yanlƒ±≈ü ≈üifre!");
  let d=S.get(OWN_U)||fresh();d=fix(d);d.avatar="founder";
  S.set(OWN_U,d);startGame(OWN_U,true);
}
function doRegister(){
  const un=document.getElementById("rUser").value.trim();
  const pw=document.getElementById("rPass").value;
  const p2=document.getElementById("rPass2").value;
  if(!un||!pw)return setMsg("T√ºm alanlarƒ± doldur!");
  if(un===OWN_U)return setMsg("Bu kullanƒ±cƒ± adƒ± alƒ±nmƒ±≈ü!");
  if(pw!==p2)return setMsg("≈ûifreler e≈üle≈ümiyor!");
  if(un.length<3)return setMsg("En az 3 karakter!");
  if(S.get(un))return setMsg("Bu kullanƒ±cƒ± adƒ± alƒ±nmƒ±≈ü!");
  const d=fresh();d.password=btoa(pw);d.avatar=selAv;
  S.set(un,d);setMsg("Kayƒ±t ba≈üarƒ±lƒ±!",true);
  setTimeout(()=>{switchTab("login");document.getElementById("lUser").value=un;},1400);
}
function doLogout(){
  me=null;isOwner=false;
  cancelAnimationFrame(animId);clearInterval(tickId);clearInterval(autoFeedId);clearInterval(wxId);
  document.getElementById("gameScreen").style.display="none";
  document.getElementById("authScreen").style.display="flex";
  document.getElementById("lUser").value="";document.getElementById("lPass").value="";
  colorLight=false;storm=false;sp={};
}

// ==================== GAME START ====================
function startGame(un,owner){
  me=un;isOwner=owner;
  document.getElementById("authScreen").style.display="none";
  document.getElementById("gameScreen").style.display="block";
  let d=S.get(me);d=fix(d);d=initQ(d);
  d.qs.level=d.level;d.qs.coinsNow=Math.floor(d.coins);d.qs.fishCount=d.fish.length;
  S.set(me,d);
  sp={};(d.specials||[]).forEach(s=>sp[s]=true);
  colorLight=!!sp["sp_light"];storm=!!sp["sp_storm"];
  document.getElementById("tAvatar").src=AVATARS[d.avatar]||AVATARS.nemo;
  document.getElementById("tUser").textContent=me;
  document.getElementById("tOwner").style.display=owner?"":"none";
  document.getElementById("tDev").style.display=owner?"":"none";
  document.getElementById("ownerBtn").style.display=owner?"":"none";
  if(d.gifts&&d.gifts.length>0)setTimeout(openQuests,900);
  setupCanvas();runLoop();
  tickId=setInterval(()=>{
    let d=S.get(me);d=fix(d);
    d.fish.forEach(f=>f.hunger=Math.max(0,(f.hunger||100)-4));
    if(!isOwner){
      const cm=wx.cm*(sp["sp_magnet"]?2:1);
      const xm=sp["sp_double"]?2:1;
      d.coins = Number(d.coins) + Math.max(1,d.fish.length)*2*cm;
      const xpg=Math.max(1,Math.floor(d.fish.length*.5))*xm;
      const ol=d.level;d.xp+=xpg;
      for(let i=LVL.length-1;i>=0;i--){if(d.xp>=LVL[i].xp){d.level=LVL[i].l;break;}}
      if(d.level>ol){showLvlUp(d.level);d.qs.level=d.level;}
      d.qs.coinsNow=Math.floor(d.coins);d.qs.fishCount=d.fish.length;
    }
    S.set(me,d);chkBadges(d);syncQ(d);updateUI();
  },8000);
  wxId=setInterval(()=>{wx=WX[Math.floor(Math.random()*WX.length)];setWx();notif(`${wx.icon} Hava: ${wx.name}!`);},60000);
  if(sp["sp_feed"])startAutoFeed();
  updateUI();setWx();
}
function startAutoFeed(){
  clearInterval(autoFeedId);
  autoFeedId=setInterval(()=>{
    let d=S.get(me);d=fix(d);
    d.fish.forEach(f=>f.hunger=Math.min(100,(f.hunger||0)+25));
    S.set(me,d);updateUI();notif("üåæ Otomatik yem!");
  },30000);
}
function setWx(){
  document.getElementById("weatherIcon").textContent=wx.icon;
  document.getElementById("weatherName").textContent=wx.name;
  document.getElementById("weatherDesc").textContent=wx.desc;
}

// ==================== CANVAS ====================
const CV=document.getElementById("aquariumCanvas");
const cx=CV.getContext("2d");
let bb=[];
function setupCanvas(){resize();window.addEventListener("resize",resize);CV.addEventListener("click",onCVClick);bb=Array.from({length:32},()=>nb(true));}
function resize(){const sp=window.innerWidth>680?238:0;CV.width=window.innerWidth-sp;CV.height=window.innerHeight;}
function nb(rand){return{x:Math.random()*(CV.width||800),y:rand?Math.random()*(CV.height||600):(CV.height||600)+10,r:Math.random()*5+2,sp:Math.random()*.5+.25,wo:Math.random()*Math.PI*2};}
function runLoop(){function loop(ts){draw(ts);animId=requestAnimationFrame(loop);}animId=requestAnimationFrame(loop);}

function draw(ts){
  const W=CV.width,H=CV.height;
  cx.clearRect(0,0,W,H);
  const base=wx.name==="Gece"?"#000508":wx.name==="Karlƒ±"?"#051525":"#020e1f";
  const bg=cx.createLinearGradient(0,0,0,H);
  bg.addColorStop(0,base);bg.addColorStop(.55,"#031e42");bg.addColorStop(1,"#010810");
  cx.fillStyle=bg;cx.fillRect(0,0,W,H);
  if(wx.name==="Karlƒ±"){cx.fillStyle="rgba(200,230,255,.25)";cx.fillRect(0,0,W,H);}
  if(colorLight){const h=(ts/28)%360;const lg=cx.createRadialGradient(W/2,H/2,0,W/2,H/2,W*.75);lg.addColorStop(0,`hsla(${h},100%,55%,.04)`);lg.addColorStop(1,"transparent");cx.fillStyle=lg;cx.fillRect(0,0,W,H);}
  for(let i=0;i<5;i++){const rx=W/5*i+W/10;const rg=cx.createLinearGradient(rx,0,rx+40,H*.7);rg.addColorStop(0,"rgba(0,212,255,.037)");rg.addColorStop(1,"transparent");cx.fillStyle=rg;cx.beginPath();cx.moveTo(rx-20,0);cx.lineTo(rx+22,0);cx.lineTo(rx+70,H*.7);cx.lineTo(rx-20,H*.7);cx.fill();}
  const sg=cx.createLinearGradient(0,H-65,0,H);sg.addColorStop(0,"rgba(160,120,65,0)");sg.addColorStop(.35,"rgba(145,105,50,.35)");sg.addColorStop(1,"rgba(125,90,35,.6)");cx.fillStyle=sg;cx.fillRect(0,H-65,W,65);
  const bs=wx.name==="Fƒ±rtƒ±nalƒ±"?3:1;
  bb.forEach(b=>{b.y-=b.sp*bs;b.wo+=.02;b.x+=Math.sin(b.wo)*.35;if(b.y<-10)Object.assign(b,nb(false));cx.beginPath();cx.arc(b.x,b.y,b.r,0,Math.PI*2);cx.strokeStyle=`rgba(0,212,255,${.1+Math.sin(ts/600)*.04})`;cx.lineWidth=1;cx.stroke();cx.fillStyle="rgba(100,220,255,.03)";cx.fill();});
  const d=S.get(me);if(!d)return;
  cx.textAlign="center";cx.textBaseline="middle";
  d.decors.forEach(dc=>{cx.font=`${dc.sz||28}px serif`;cx.fillText(dc.emoji,dc.x,dc.y);});
  const ws=wx.sm,sm=storm?2.2:1;
  d.fish.forEach(f=>{
    const fp=FP[f.type]||FP.normal;
    f.x+=f.vx*sm*ws;f.y+=f.vy*sm*ws+Math.sin(ts/480+f.ph)*.35;
    if(f.x<35){f.vx=Math.abs(f.vx);f.dir=1;}if(f.x>W-35){f.vx=-Math.abs(f.vx);f.dir=-1;}
    if(f.y<55){f.vy=Math.abs(f.vy)*.5;}if(f.y>H-85){f.vy=-Math.abs(f.vy)*.5;}
    const fd=SHOP.fish.find(x=>x.id===f.type)||SHOP.fish[0];const sz=fp.sz*26;
    cx.save();cx.translate(f.x,f.y);cx.scale(f.dir||1,1);
    const h=f.hunger||0;
    if(h<30){cx.shadowColor="rgba(255,60,60,.9)";cx.shadowBlur=16;}
    else if(h<60){cx.shadowColor="rgba(255,180,0,.5)";cx.shadowBlur=8;}
    cx.font=`${sz}px serif`;cx.textAlign="center";cx.textBaseline="middle";cx.fillText(fd.emoji,0,0);
    cx.restore();
    cx.fillStyle="rgba(200,240,255,.55)";cx.font="9px Quicksand,sans-serif";cx.textAlign="center";cx.fillText(f.name,f.x,f.y-sz/2-5);
  });
  S.set(me,d);
}

function onCVClick(e){
  const modals=["shopOverlay","questOverlay","ownerOverlay","profileOverlay"];
  if(modals.some(id=>document.getElementById(id).classList.contains("open")))return;
  const r=CV.getBoundingClientRect(),x=e.clientX-r.left,y=e.clientY-r.top;
  const pt=document.createElement("div");pt.className="feed-pt";pt.textContent="üåæ";
  pt.style.left=e.clientX+"px";pt.style.top=e.clientY+"px";document.body.appendChild(pt);setTimeout(()=>pt.remove(),1000);
  let d=S.get(me);d=fix(d);let fed=false;
  d.fish.forEach(f=>{if(Math.hypot(f.x-x,f.y-y)<95){f.hunger=Math.min(100,(f.hunger||0)+30);fed=true;}});
  if(fed){d.qs.feedCount=(d.qs.feedCount||0)+1;S.set(me,d);syncQ(d);updateUI();notif("üåæ Balƒ±k beslendi!");}
}

// ==================== MODAL HELPERS ====================
function openM(id){document.getElementById(id).classList.add("open");}
function closeM(id){document.getElementById(id).classList.remove("open");}
function oClick(e,id){if(e.target===document.getElementById(id))closeM(id);}

// ==================== PROFILE ====================
function openProfile(){
  let d=S.get(me);d=fix(d);
  const li=getLvl(d.xp);
  document.getElementById("profileBody").innerHTML=`
    <img class="profile-av-big" src="${AVATARS[d.avatar]||AVATARS.nemo}" alt>
    <div class="profile-username">${me}</div>
    <div class="profile-level">${isOwner?"üëë Kurucu":li.cur.n}</div>
    <div class="profile-stats">
      <div class="stat-box"><div class="stat-val">${isOwner?"‚àû":Math.floor(d.coins)}</div><div class="stat-lbl">üí∞ Coin</div></div>
      <div class="stat-box"><div class="stat-val">${isOwner?"MAX":d.level}</div><div class="stat-lbl">‚≠ê Seviye</div></div>
      <div class="stat-box"><div class="stat-val">${d.fish.length}</div><div class="stat-lbl">üê† Balƒ±k</div></div>
      <div class="stat-box"><div class="stat-val">${d.qDone||0}</div><div class="stat-lbl">üìã G√∂rev</div></div>
    </div>
    <div class="profile-sec">üèÖ ROZETLER</div>
    <div class="profile-badges">${
      !d.badges||d.badges.length===0
        ?'<div class="no-content">Hen√ºz rozet yok</div>'
        :d.badges.map(bid=>{const b=BADGES.find(x=>x.id===bid);return b?`<div class="pb-item">${b.icon}<span>${b.name}</span></div>`:""}).join("")
    }</div>`;
  openM("profileOverlay");
}

// ==================== QUESTS ====================
function syncQ(d){
  let ch=false;
  Object.keys(d.quests).forEach(qid=>{
    const qd=QDEFS.find(x=>x.id===qid);if(!qd)return;
    const q=d.quests[qid];if(q.claimed)return;
    const val=d.qs[qd.stat]||0;
    const prog=Math.min(qd.goal,val);
    if(prog!==q.prog){q.prog=prog;ch=true;}
  });
  if(ch)S.set(me,d);
}

function openQuests(){
  let d=S.get(me);d=fix(d);syncQ(d);
  // gifts
  const gs=document.getElementById("giftSection");
  if(d.gifts&&d.gifts.length>0){
    gs.style.display="block";
    gs.innerHTML=`<div class="section-title">üéÅ Y√ñNETƒ∞Cƒ∞ HEDƒ∞YELERƒ∞</div>`+
      d.gifts.map((g,i)=>`
        <div class="gift-card">
          <div class="gift-icon">üéÅ</div>
          <div class="gift-info">
            <div class="gift-title">üëë <b>${OWN_U}</b> size hediye g√∂nderdi!</div>
            <div class="gift-msg">${g.message}</div>
          </div>
          <button class="gift-claim-btn" onclick="claimGift(${i})">‚úì Aldƒ±m!</button>
        </div>`).join("");
  }else{gs.style.display="none";gs.innerHTML="";}
  // quests
  const el=document.getElementById("questList");el.innerHTML="";
  Object.keys(d.quests).forEach(qid=>{
    const qd=QDEFS.find(x=>x.id===qid);if(!qd)return;
    const q=d.quests[qid];
    const pct=Math.min(100,(q.prog/qd.goal)*100);
    const done=q.prog>=qd.goal;
    const c=document.createElement("div");c.className="quest-card"+(q.claimed?" claimed":"");
    c.innerHTML=`
      <span class="quest-icon">${qd.icon}</span>
      <div class="quest-info">
        <div class="quest-name">${qd.name}</div>
        <div class="quest-desc">${qd.desc}</div>
        <div class="quest-prog-wrap"><div class="quest-prog-fill" style="width:${pct}%"></div></div>
        <div class="quest-prog-text">${q.prog} / ${qd.goal}</div>
        ${done&&!q.claimed?`<button class="quest-claim-btn" onclick="claimQ('${qid}')">üí∞ +${qd.reward} Al!</button>`:""}
        ${q.claimed?`<div class="quest-done-lbl">‚úì Tamamlandƒ±</div>`:""}
      </div>
      <div class="quest-reward">üí∞ ${qd.reward}</div>`;
    el.appendChild(c);
  });
  const now=new Date(),mid=new Date(now);mid.setHours(24,0,0,0);
  const diff=mid-now,h=Math.floor(diff/3600000),m=Math.floor((diff%3600000)/60000);
  document.getElementById("questTimer").textContent=`üïê Yenilenmesine: ${h}s ${m}dk`;
  openM("questOverlay");
}

function claimGift(i){
  let d=S.get(me);d=fix(d);
  if(!d.gifts||i>=d.gifts.length)return;
  const g=d.gifts.splice(i,1)[0];
  if(g.type==="coin")d.coins=Number(d.coins)+Number(g.amount);
  if(g.type==="badge"&&!d.badges.includes(g.badgeId))d.badges.push(g.badgeId);
  if(g.type==="item"&&!d.specials.includes(g.itemId)){d.specials.push(g.itemId);sp[g.itemId]=true;if(g.itemId==="sp_light")colorLight=true;if(g.itemId==="sp_storm")storm=true;}
  S.set(me,d);updateUI();notif("üéÅ Hediye alƒ±ndƒ±!");openQuests();
}

function claimQ(qid){
  let d=S.get(me);d=fix(d);
  const qd=QDEFS.find(x=>x.id===qid);if(!qd)return;
  const q=d.quests[qid];
  if(!q||q.claimed||q.prog<qd.goal)return;
  q.claimed=true;
  d.coins=Number(d.coins)+Number(qd.reward);
  d.qDone=(d.qDone||0)+1;
  d.qs.coinsNow=Math.floor(d.coins);
  S.set(me,d);chkBadges(d);updateUI();notif(`üéâ +${qd.reward} coin!`);openQuests();
}

// ==================== SHOP ====================
function openShop(){renderShop();openM("shopOverlay");}
function setCat(c){
  curCat=c;
  document.querySelectorAll(".cat-btn").forEach((b,i)=>b.classList.toggle("active",["fish","decor","special"][i]===c));
  renderShop();
}
function renderShop(){
  let d=S.get(me);d=fix(d);
  const ul=isOwner?99:d.level;
  document.getElementById("shopCoins").textContent=isOwner?"‚àû":Math.floor(d.coins);
  document.getElementById("shopGrid").innerHTML=SHOP[curCat].map(item=>{
    const owned=curCat==="special"&&(d.specials||[]).includes(item.id);
    const locked=curCat==="fish"&&(item.minLvl||1)>ul;
    const canBuy=!owned&&!locked;
    const afford=isOwner||d.coins>=item.price;
    const speedT=item.speed?`<div class="sc-speed">‚ö° ${item.speed}</div>`:"";
    const lockT=locked?`<div class="sc-req">üîí Seviye ${item.minLvl}</div>`:"";
    const priceS=locked?`Lv.${item.minLvl}`:isOwner?"‚àû":`üí∞ ${item.price}`;
    let btnLabel=owned?"‚úì Aktif":locked?"üîí Kilitli":!afford?`‚ùå ${item.price} gerekli`:"Satƒ±n Al";
    let btnCls="card-btn"+(owned?" owned":"");
    let onclick="";
    if(canBuy){
      if(curCat==="fish")onclick=`buyFish("${item.id}")`;
      else if(curCat==="decor")onclick=`buyDecor("${item.id}")`;
      else onclick=`buySpecial("${item.id}")`;
    }
    return`<div class="shop-card ${item.rarity||""} ${locked?"locked":""}">
      <span class="sc-icon">${item.emoji}</span>
      <div class="sc-name">${item.name}</div>
      <div class="sc-desc">${item.desc||""}</div>
      ${speedT}${lockT}
      <div class="sc-price">${priceS}</div>
      <button class="${btnCls}" ${onclick?`onclick="${onclick}"`:canBuy?"":"disabled"}>${btnLabel}</button>
    </div>`;
  }).join("");
}

function buyFish(type){
  let d=S.get(me);d=fix(d);
  const item=SHOP.fish.find(x=>x.id===type);if(!item)return;
  const ul=isOwner?99:d.level;
  if((item.minLvl||1)>ul)return notif(`üîí Seviye ${item.minLvl} gerekli!`);
  if(!isOwner&&d.coins<item.price)return notif(`‚ùå Para yok! Gereken:${item.price} Sahip:${Math.floor(d.coins)}`);
  if(!isOwner)d.coins=Number(d.coins)-Number(item.price);
  const fp=FP[type]||FP.normal;
  const names=["Nemo","Dori","Splash","Goldie","Finley","Marina","Bubbles","Jaws","Wave","Coral","Lucky","Storm","Nova","Pearl","Finn"];
  d.fishCtr=(d.fishCtr||0)+1;
  const W=CV.width||800,H=CV.height||600;
  d.fish.push({id:d.fishCtr,type,name:names[Math.floor(Math.random()*names.length)]+d.fishCtr,x:120+Math.random()*(W-240),y:100+Math.random()*(H-240),vx:(Math.random()-.5)*fp.spd*2,vy:(Math.random()-.5)*.4,dir:Math.random()>.5?1:-1,ph:Math.random()*Math.PI*2,hunger:100});
  d.qs.buyCount=(d.qs.buyCount||0)+1;d.qs.fishCount=d.fish.length;
  S.set(me,d);chkBadges(d);syncQ(d);updateUI();notif(`${item.emoji} ${item.name} eklendi!`);renderShop();
}

function buyDecor(type){
  let d=S.get(me);d=fix(d);
  const item=SHOP.decor.find(x=>x.id===type);if(!item)return;
  if(!isOwner&&d.coins<item.price)return notif(`‚ùå Para yok! Gereken:${item.price} Sahip:${Math.floor(d.coins)}`);
  if(!isOwner)d.coins=Number(d.coins)-Number(item.price);
  const W=CV.width||800,H=CV.height||600;
  d.decors.push({type,emoji:item.emoji,x:60+Math.random()*(W-120),y:H-42-Math.random()*22,sz:24+Math.random()*10});
  d.qs.decorCount=(d.qs.decorCount||0)+1;
  S.set(me,d);syncQ(d);updateUI();notif(`${item.emoji} ${item.name} eklendi!`);renderShop();
}

function buySpecial(type){
  let d=S.get(me);d=fix(d);
  const item=SHOP.special.find(x=>x.id===type);if(!item)return;
  if((d.specials||[]).includes(type))return notif("Zaten sahipsin!");
  if(!isOwner&&d.coins<item.price)return notif(`‚ùå Para yok! Gereken:${item.price} Sahip:${Math.floor(d.coins)}`);
  if(!isOwner)d.coins=Number(d.coins)-Number(item.price);
  d.specials.push(type);S.set(me,d);
  sp[type]=true;
  if(type==="sp_feed")startAutoFeed();
  if(type==="sp_light")colorLight=true;
  if(type==="sp_storm")storm=true;
  updateUI();notif(`${item.emoji} Aktif!`);renderShop();
}

// ==================== LEVEL ====================
function getLvl(xp){
  let cur=LVL[0];
  for(let i=0;i<LVL.length;i++){if(xp>=LVL[i].xp)cur=LVL[i];}
  return{cur,next:LVL.find(l=>l.xp>xp)};
}
function showLvlUp(lvl){
  const li=LVL.find(l=>l.l===lvl)||LVL[LVL.length-1];
  const el=document.createElement("div");el.className="levelup";
  el.innerHTML=`<h2 style="font-family:'Orbitron',monospace;font-size:11px;color:var(--accent2);letter-spacing:3px;margin-bottom:12px">‚≠ê SEVƒ∞YE ATLADIN!</h2>
    <span class="bp-icon">üéâ</span>
    <div class="bp-name-g">Seviye ${lvl}</div>
    <div class="bp-desc"
       <div class="bp-desc">${li.n}</div>
    <button class="popup-btn-g" onclick="this.parentElement.remove();renderShop()">Harika!</button>`;
  document.body.appendChild(el);
}

// ==================== BADGES ====================
function chkBadges(d){
  const n=d.fish.length,b=d.badges;let got=null;
  if(n>=1&&!b.includes("first_fish")){b.push("first_fish");got=BADGES.find(x=>x.id==="first_fish");}
  if(n>=13&&!b.includes("beta")){b.push("beta");got=BADGES.find(x=>x.id==="beta");}
  if(n>=20&&!b.includes("master")){b.push("master");got=BADGES.find(x=>x.id==="master");}
  if(!isOwner&&d.coins>=1000&&!b.includes("rich")){b.push("rich");got=BADGES.find(x=>x.id==="rich");}
  if(new Set(d.fish.map(f=>f.type)).size>=8&&!b.includes("collector")){b.push("collector");got=BADGES.find(x=>x.id==="collector");}
  if(d.level>=7&&!b.includes("max_level")){b.push("max_level");got=BADGES.find(x=>x.id==="max_level");}
  if((d.qDone||0)>=10&&!b.includes("quest_hero")){b.push("quest_hero");got=BADGES.find(x=>x.id==="quest_hero");}
  if(got){S.set(me,d);showBadge(got);}
}
function showBadge(b){
  const el=document.createElement("div");el.className="badge-popup";
  el.innerHTML=`<h2 style="font-family:'Orbitron',monospace;font-size:11px;color:var(--gold);letter-spacing:3px;margin-bottom:12px">üéâ ROZET KAZANDIN!</h2>
    <span class="bp-icon">${b.icon}</span>
    <div class="bp-name">${b.name}</div>
    <div class="bp-desc">${b.desc}</div>
    <button class="popup-btn" onclick="this.parentElement.remove()">Harika!</button>`;
  document.body.appendChild(el);
}

// ==================== OWNER ====================
let oUsers=[];
function openOwner(){
  oUsers=Object.keys(S.all()).filter(u=>u!==OWN_U);
  oTab("badge");openM("ownerOverlay");
}
function oTab(tab){
  curOTab=tab;
  document.querySelectorAll(".owner-tab").forEach((b,i)=>b.classList.toggle("active",["badge","coin","item"][i]===tab));
  renderOwner();
}
function renderOwner(){
  const el=document.getElementById("ownerContent");
  if(!oUsers.length){el.innerHTML='<div style="color:rgba(200,240,255,.32);font-size:13px;text-align:center;padding:20px">Kayƒ±tlƒ± kullanƒ±cƒ± yok</div>';return;}
  el.innerHTML=oUsers.map(un=>{
    const ud=S.get(un);
    const av=AVATARS[(ud&&ud.avatar)||"nemo"]||AVATARS.nemo;
    const coins=Math.floor((ud&&ud.coins)||0);
    const lvl=(ud&&ud.level)||1;
    const fish=(ud&&ud.fish&&ud.fish.length)||0;
    const top=`<div class="u-row-top"><img class="u-av" src="${av}" alt><div class="u-info"><div class="u-name">${un}</div><div class="u-stats">Lv.${lvl} ¬∑ ${fish} balƒ±k ¬∑ üí∞${coins}</div></div></div>`;
    if(curOTab==="badge"){
      const manual=BADGES.filter(b=>!b.auto);
      return`<div class="u-row">${top}<select class="o-select" id="bs_${un}">${manual.map(b=>`<option value="${b.id}">${b.icon} ${b.name}</option>`).join("")}</select><button class="o-btn o-btn-gold" onclick="sendBadge('${un}')">üèÖ Rozet G√∂nder</button></div>`;
    }
    if(curOTab==="coin")return`<div class="u-row">${top}<input class="o-input" id="ca_${un}" type="number" placeholder="Coin miktarƒ±" min="1"><button class="o-btn o-btn-gold" onclick="sendCoin('${un}')">üí∞ G√∂nder</button></div>`;
    if(curOTab==="item")return`<div class="u-row">${top}<select class="o-select" id="is_${un}">${SHOP.special.map(s=>`<option value="${s.id}">${s.emoji} ${s.name}</option>`).join("")}</select><button class="o-btn o-btn-green" onclick="sendItem('${un}')">üéÅ Item G√∂nder</button></div>`;
    return"";
  }).join("");
}
function sendBadge(un){
  const sel=document.getElementById(`bs_${un}`);if(!sel)return;
  const bid=sel.value;const d=S.get(un);if(!d)return;
  if(!d.badges)d.badges=[];
  if(d.badges.includes(bid))return notif("‚ö†Ô∏è Bu rozet zaten var!");
  const bdef=BADGES.find(x=>x.id===bid);
  if(!d.gifts)d.gifts=[];
  d.gifts.push({type:"badge",badgeId:bid,message:`üèÖ <b>${bdef?.icon} ${bdef?.name}</b> rozeti hediye edildi!`});
  d.badges.push(bid);S.set(un,d);notif(`‚úÖ ${un} kullanƒ±cƒ±sƒ±na rozet g√∂nderildi!`);
}
function sendCoin(un){
  const inp=document.getElementById(`ca_${un}`);if(!inp)return;
  const amount=parseInt(inp.value)||0;
  if(amount<=0)return notif("‚ùå Ge√ßersiz miktar!");
  const d=S.get(un);if(!d)return;
  if(!d.gifts)d.gifts=[];
  d.gifts.push({type:"coin",amount,message:`üí∞ <b>${amount} coin</b> hediye edildi!`});
  d.coins=Number(d.coins)+Number(amount);
  S.set(un,d);inp.value="";notif(`‚úÖ ${un} kullanƒ±cƒ±sƒ±na ${amount} coin g√∂nderildi!`);
}
function sendItem(un){
  const sel=document.getElementById(`is_${un}`);if(!sel)return;
  const itemId=sel.value;const d=S.get(un);if(!d)return;
  if((d.specials||[]).includes(itemId))return notif("‚ö†Ô∏è Bu item zaten var!");
  const idef=SHOP.special.find(x=>x.id===itemId);
  if(!d.gifts)d.gifts=[];
  d.gifts.push({type:"item",itemId,message:`${idef?.emoji} <b>${idef?.name}</b> √∂zel e≈üyasƒ± hediye edildi!`});
  if(!d.specials)d.specials=[];d.specials.push(itemId);
  S.set(un,d);notif(`‚úÖ ${un} kullanƒ±cƒ±sƒ±na ${idef?.name} g√∂nderildi!`);
}

// ==================== UI ====================
function updateUI(){
  let d=S.get(me);if(!d)return;d=fix(d);
  const{cur,next}=getLvl(d.xp);
  document.getElementById("tCoins").textContent=isOwner?"‚àû":Math.floor(d.coins);
  document.getElementById("tLevel").textContent=isOwner?"MAX":d.level;
  document.getElementById("sLevel").textContent=isOwner?"MAX":d.level;
  document.getElementById("sLevelName").textContent=isOwner?"Kurucu":cur.n;
  if(next&&!isOwner){const p=Math.min(100,((d.xp-cur.xp)/(next.xp-cur.xp))*100);document.getElementById("xpBar").style.width=p+"%";document.getElementById("xpLabel").textContent=`${d.xp} / ${next.xp} XP`;}
  else{document.getElementById("xpBar").style.width="100%";document.getElementById("xpLabel").textContent="MAX üî±";}
  document.getElementById("sFishCount").textContent=d.fish.length;
  const fl=document.getElementById("sFishList");
  fl.innerHTML=d.fish.length===0?'<div class="no-content">Hen√ºz balƒ±k yok</div>':
    d.fish.map(f=>{const h=f.hunger||0;const c=h>60?"#00ff9d":h>30?"#ffaa00":"#ff4444";const fd=SHOP.fish.find(x=>x.id===f.type)||SHOP.fish[0];
      return`<div class="fish-row"><span>${fd.emoji}</span><span style="flex:1">${f.name}</span><div class="hunger-bar"><div class="hunger-fill" style="width:${h}%;background:${c}"></div></div></div>`;
    }).join("");
  const be=document.getElementById("sBadges");const bs=d.badges||[];
  be.innerHTML=bs.length===0?'<div class="no-content">Hen√ºz rozet yok</div>':
    bs.map(bid=>{const b=BADGES.find(x=>x.id===bid);return b?`<span class="badge-chip">${b.icon} ${b.name}</span>`:""}).join("");
}
function notif(text){const el=document.createElement("div");el.className="notif";el.textContent=text;document.body.appendChild(el);setTimeout(()=>el.remove(),3000);}

document.addEventListener("keydown",e=>{
  if(e.key!=="Enter")return;
  if(document.getElementById("loginForm").style.display!=="none")doLogin();
  else if(document.getElementById("registerForm").style.display!=="none")doRegister();
  else if(document.getElementById("founderForm").style.display!=="none")doFounderLogin();
});
</script>
</body>
</html>
// ==================== STATE ====================
let me=null,isOwner=false,animId=null,tickId=null,autoFeedId=null,wxId=null;
let curCat="fish",selAv="nemo",curOTab="badge";
let sp={},colorLight=false,storm=false,wx=WX[0];

// ==================== STORAGE ====================
const S={
  all:()=>JSON.parse(localStorage.getItem("aqw8_u")||"{}"),
  save:u=>localStorage.setItem("aqw8_u",JSON.stringify(u)),
  get:n=>{const u=S.all();return u[n]||null;},
  set:(n,d)=>{const u=S.all();u[n]=d;S.save(u);},
};

function fresh(){return{coins:200,fish:[],decors:[],badges:[],specials:[],fishCtr:0,password:"",xp:0,level:1,avatar:"nemo",quests:{},qs:{feedCount:0,buyCount:0,decorCount:0,loginCount:0,coinsNow:200,level:1,fishCount:0},lastQD:"",qDone:0,gifts:[]};}

function fix(d){
  // FIXED: parse coins as number
  if(isOwner){d.coins=999999999;}
  else{d.coins=Number(d.coins)||0;}
  d.xp=parseInt(d.xp)||0;
  d.level=parseInt(d.level)||1;
  if(!Array.isArray(d.fish))d.fish=[];
  if(!Array.isArray(d.decors))d.decors=[];
  if(!Array.isArray(d.badges))d.badges=[];
  if(!Array.isArray(d.specials))d.specials=[];
  if(!d.fishCtr)d.fishCtr=0;
  if(!d.avatar)d.avatar="nemo";
  if(!d.quests)d.quests={};
  if(!d.qDone)d.qDone=0;
  if(!Array.isArray(d.gifts))d.gifts=[];
  if(!d.qs)d.qs={feedCount:0,buyCount:0,decorCount:0,loginCount:0,coinsNow:0,level:1,fishCount:0};
  return d;
}

function today(){const n=new Date();return`${n.getFullYear()}-${n.getMonth()}-${n.getDate()}`;}

function initQ(d){
  if(d.lastQD!==today()){
    const s=[...QDEFS].sort(()=>Math.random()-.5).slice(0,5);
    d.quests={};s.forEach(q=>{d.quests[q.id]={prog:0,claimed:false};});
    d.lastQD=today();d.qs.feedCount=0;d.qs.buyCount=0;d.qs.decorCount=0;d.qs.loginCount=1;
  }else{d.qs.loginCount=Math.max(1,d.qs.loginCount||0);}
  return d;
}

// ==================== AUTH ====================
function switchTab(t){
  document.querySelectorAll(".tab-btn").forEach((b,i)=>b.classList.toggle("active",i===(t==="login"?0:1)));
  document.getElementById("loginForm").style.display=t==="login"?"":"none";
  document.getElementById("registerForm").style.display=t==="register"?"":"none";
  document.getElementById("founderForm").style.display="none";
  setMsg("");
}
function showFounder(){document.getElementById("loginForm").style.display="none";document.getElementById("founderForm").style.display="";}
function hideFounder(){document.getElementById("loginForm").style.display="";document.getElementById("founderForm").style.display="none";}
function setMsg(t,ok){const e=document.getElementById("authMsg");e.textContent=t;e.className="auth-msg "+(ok?"ok":"err");}
function pickAv(el){document.querySelectorAll(".av-option").forEach(a=>a.classList.remove("selected"));el.classList.add("selected");selAv=el.dataset.av;}

function doLogin(){
  const un=document.getElementById("lUser").value.trim();
  const pw=document.getElementById("lPass").value;
  if(!un||!pw)return setMsg("T√ºm alanlarƒ± doldur!");
  const d=S.get(un);
  if(!d)return setMsg("Kullanƒ±cƒ± bulunamadƒ±!");
  if(d.password!==btoa(pw))return setMsg("≈ûifre yanlƒ±≈ü!");
  startGame(un,false);
}
function doFounderLogin(){
  const pw=document.getElementById("fPass").value;
  if(pw!==OWN_P)return setMsg("Yanlƒ±≈ü ≈üifre!");
  let d=S.get(OWN_U)||fresh();d=fix(d);d.avatar="founder";
  S.set(OWN_U,d);startGame(OWN_U,true);
}
function doRegister(){
  const un=document.getElementById("rUser").value.trim();
  const pw=document.getElementById("rPass").value;
  const p2=document.getElementById("rPass2").value;
  if(!un||!pw)return setMsg("T√ºm alanlarƒ± doldur!");
  if(un===OWN_U)return setMsg("Bu kullanƒ±cƒ± adƒ± alƒ±nmƒ±≈ü!");
  if(pw!==p2)return setMsg("≈ûifreler e≈üle≈ümiyor!");
  if(un.length<3)return setMsg("En az 3 karakter!");
  if(S.get(un))return setMsg("Bu kullanƒ±cƒ± adƒ± alƒ±nmƒ±≈ü!");
  const d=fresh();d.password=btoa(pw);d.avatar=selAv;
  S.set(un,d);setMsg("Kayƒ±t ba≈üarƒ±lƒ±!",true);
  setTimeout(()=>{switchTab("login");document.getElementById("lUser").value=un;},1400);
}
function doLogout(){
  me=null;isOwner=false;
  cancelAnimationFrame(animId);clearInterval(tickId);clearInterval(autoFeedId);clearInterval(wxId);
  document.getElementById("gameScreen").style.display="none";
  document.getElementById("authScreen").style.display="flex";
  document.getElementById("lUser").value="";document.getElementById("lPass").value="";
  colorLight=false;storm=false;sp={};
}

// ==================== GAME START ====================
function startGame(un,owner){
  me=un;isOwner=owner;
  document.getElementById("authScreen").style.display="none";
  document.getElementById("gameScreen").style.display="block";
  let d=S.get(me);d=fix(d);d=initQ(d);
  d.qs.level=d.level;d.qs.coinsNow=Math.floor(d.coins);d.qs.fishCount=d.fish.length;
  S.set(me,d);
  sp={};(d.specials||[]).forEach(s=>sp[s]=true);
  colorLight=!!sp["sp_light"];storm=!!sp["sp_storm"];
  document.getElementById("tAvatar").src=AVATARS[d.avatar]||AVATARS.nemo;
  document.getElementById("tUser").textContent=me;
  document.getElementById("tOwner").style.display=owner?"":"none";
  document.getElementById("tDev").style.display=owner?"":"none";
  document.getElementById("ownerBtn").style.display=owner?"":"none";
  if(d.gifts&&d.gifts.length>0)setTimeout(openQuests,900);
  setupCanvas();runLoop();
  tickId=setInterval(()=>{
    let d=S.get(me);d=fix(d);
    d.fish.forEach(f=>f.hunger=Math.max(0,(f.hunger||100)-4));
    if(!isOwner){
      const cm=wx.cm*(sp["sp_magnet"]?2:1);
      const xm=sp["sp_double"]?2:1;
      d.coins = Number(d.coins) + Math.max(1,d.fish.length)*2*cm;
      const xpg=Math.max(1,Math.floor(d.fish.length*.5))*xm;
      const ol=d.level;d.xp+=xpg;
      for(let i=LVL.length-1;i>=0;i--){if(d.xp>=LVL[i].xp){d.level=LVL[i].l;break;}}
      if(d.level>ol){showLvlUp(d.level);d.qs.level=d.level;}
      d.qs.coinsNow=Math.floor(d.coins);d.qs.fishCount=d.fish.length;
    }
    S.set(me,d);chkBadges(d);syncQ(d);updateUI();
  },8000);
  wxId=setInterval(()=>{wx=WX[Math.floor(Math.random()*WX.length)];setWx();notif(`${wx.icon} Hava: ${wx.name}!`);},60000);
  if(sp["sp_feed"])startAutoFeed();
  updateUI();setWx();
}
function startAutoFeed(){
  clearInterval(autoFeedId);
  autoFeedId=setInterval(()=>{
    let d=S.get(me);d=fix(d);
    d.fish.forEach(f=>f.hunger=Math.min(100,(f.hunger||0)+25));
    S.set(me,d);updateUI();notif("üåæ Otomatik yem!");
  },30000);
}
function setWx(){
  document.getElementById("weatherIcon").textContent=wx.icon;
  document.getElementById("weatherName").textContent=wx.name;
  document.getElementById("weatherDesc").textContent=wx.desc;
}

// ==================== CANVAS ====================
const CV=document.getElementById("aquariumCanvas");
const cx=CV.getContext("2d");
let bb=[];
function setupCanvas(){resize();window.addEventListener("resize",resize);CV.addEventListener("click",onCVClick);bb=Array.from({length:32},()=>nb(true));}
function resize(){const sp=window.innerWidth>680?238:0;CV.width=window.innerWidth-sp;CV.height=window.innerHeight;}
function nb(rand){return{x:Math.random()*(CV.width||800),y:rand?Math.random()*(CV.height||600):(CV.height||600)+10,r:Math.random()*5+2,sp:Math.random()*.5+.25,wo:Math.random()*Math.PI*2};}
function runLoop(){function loop(ts){draw(ts);animId=requestAnimationFrame(loop);}animId=requestAnimationFrame(loop);}

function draw(ts){
  const W=CV.width,H=CV.height;
  cx.clearRect(0,0,W,H);
  const base=wx.name==="Gece"?"#000508":wx.name==="Karlƒ±"?"#051525":"#020e1f";
  const bg=cx.createLinearGradient(0,0,0,H);
  bg.addColorStop(0,base);bg.addColorStop(.55,"#031e42");bg.addColorStop(1,"#010810");
  cx.fillStyle=bg;cx.fillRect(0,0,W,H);
  if(wx.name==="Karlƒ±"){cx.fillStyle="rgba(200,230,255,.25)";cx.fillRect(0,0,W,H);}
  if(colorLight){const h=(ts/28)%360;const lg=cx.createRadialGradient(W/2,H/2,0,W/2,H/2,W*.75);lg.addColorStop(0,`hsla(${h},100%,55%,.04)`);lg.addColorStop(1,"transparent");cx.fillStyle=lg;cx.fillRect(0,0,W,H);}
  for(let i=0;i<5;i++){const rx=W/5*i+W/10;const rg=cx.createLinearGradient(rx,0,rx+40,H*.7);rg.addColorStop(0,"rgba(0,212,255,.037)");rg.addColorStop(1,"transparent");cx.fillStyle=rg;cx.beginPath();cx.moveTo(rx-20,0);cx.lineTo(rx+22,0);cx.lineTo(rx+70,H*.7);cx.lineTo(rx-20,H*.7);cx.fill();}
  const sg=cx.createLinearGradient(0,H-65,0,H);sg.addColorStop(0,"rgba(160,120,65,0)");sg.addColorStop(.35,"rgba(145,105,50,.35)");sg.addColorStop(1,"rgba(125,90,35,.6)");cx.fillStyle=sg;cx.fillRect(0,H-65,W,65);
  const bs=wx.name==="Fƒ±rtƒ±nalƒ±"?3:1;
  bb.forEach(b=>{b.y-=b.sp*bs;b.wo+=.02;b.x+=Math.sin(b.wo)*.35;if(b.y<-10)Object.assign(b,nb(false));cx.beginPath();cx.arc(b.x,b.y,b.r,0,Math.PI*2);cx.strokeStyle=`rgba(0,212,255,${.1+Math.sin(ts/600)*.04})`;cx.lineWidth=1;cx.stroke();cx.fillStyle="rgba(100,220,255,.03)";cx.fill();});
  const d=S.get(me);if(!d)return;
  cx.textAlign="center";cx.textBaseline="middle";
  d.decors.forEach(dc=>{cx.font=`${dc.sz||28}px serif`;cx.fillText(dc.emoji,dc.x,dc.y);});
  const ws=wx.sm,sm=storm?2.2:1;
  d.fish.forEach(f=>{
    const fp=FP[f.type]||FP.normal;
    f.x+=f.vx*sm*ws;f.y+=f.vy*sm*ws+Math.sin(ts/480+f.ph)*.35;
    if(f.x<35){f.vx=Math.abs(f.vx);f.dir=1;}if(f.x>W-35){f.vx=-Math.abs(f.vx);f.dir=-1;}
    if(f.y<55){f.vy=Math.abs(f.vy)*.5;}if(f.y>H-85){f.vy=-Math.abs(f.vy)*.5;}
    const fd=SHOP.fish.find(x=>x.id===f.type)||SHOP.fish[0];const sz=fp.sz*26;
    cx.save();cx.translate(f.x,f.y);cx.scale(f.dir||1,1);
    const h=f.hunger||0;
    if(h<30){cx.shadowColor="rgba(255,60,60,.9)";cx.shadowBlur=16;}
    else if(h<60){cx.shadowColor="rgba(255,180,0,.5)";cx.shadowBlur=8;}
    cx.font=`${sz}px serif`;cx.textAlign="center";cx.textBaseline="middle";cx.fillText(fd.emoji,0,0);
    cx.restore();
    cx.fillStyle="rgba(200,240,255,.55)";cx.font="9px Quicksand,sans-serif";cx.textAlign="center";cx.fillText(f.name,f.x,f.y-sz/2-5);
  });
  S.set(me,d);
}

function onCVClick(e){
  const modals=["shopOverlay","questOverlay","ownerOverlay","profileOverlay"];
  if(modals.some(id=>document.getElementById(id).classList.contains("open")))return;
  const r=CV.getBoundingClientRect(),x=e.clientX-r.left,y=e.clientY-r.top;
  const pt=document.createElement("div");pt.className="feed-pt";pt.textContent="üåæ";
  pt.style.left=e.clientX+"px";pt.style.top=e.clientY+"px";document.body.appendChild(pt);setTimeout(()=>pt.remove(),1000);
  let d=S.get(me);d=fix(d);let fed=false;
  d.fish.forEach(f=>{if(Math.hypot(f.x-x,f.y-y)<95){f.hunger=Math.min(100,(f.hunger||0)+30);fed=true;}});
  if(fed){d.qs.feedCount=(d.qs.feedCount||0)+1;S.set(me,d);syncQ(d);updateUI();notif("üåæ Balƒ±k beslendi!");}
}

// ==================== MODAL HELPERS ====================
function openM(id){document.getElementById(id).classList.add("open");}
function closeM(id){document.getElementById(id).classList.remove("open");}
function oClick(e,id){if(e.target===document.getElementById(id))closeM(id);}

// ==================== PROFILE ====================
function openProfile(){
  let d=S.get(me);d=fix(d);
  const li=getLvl(d.xp);
  document.getElementById("profileBody").innerHTML=`
    <img class="profile-av-big" src="${AVATARS[d.avatar]||AVATARS.nemo}" alt>
    <div class="profile-username">${me}</div>
    <div class="profile-level">${isOwner?"üëë Kurucu":li.cur.n}</div>
    <div class="profile-stats">
      <div class="stat-box"><div class="stat-val">${isOwner?"‚àû":Math.floor(d.coins)}</div><div class="stat-lbl">üí∞ Coin</div></div>
      <div class="stat-box"><div class="stat-val">${isOwner?"MAX":d.level}</div><div class="stat-lbl">‚≠ê Seviye</div></div>
      <div class="stat-box"><div class="stat-val">${d.fish.length}</div><div class="stat-lbl">üê† Balƒ±k</div></div>
      <div class="stat-box"><div class="stat-val">${d.qDone||0}</div><div class="stat-lbl">üìã G√∂rev</div></div>
    </div>
    <div class="profile-sec">üèÖ ROZETLER</div>
    <div class="profile-badges">${
      !d.badges||d.badges.length===0
        ?'<div class="no-content">Hen√ºz rozet yok</div>'
        :d.badges.map(bid=>{const b=BADGES.find(x=>x.id===bid);return b?`<div class="pb-item">${b.icon}<span>${b.name}</span></div>`:""}).join("")
    }</div>`;
  openM("profileOverlay");
}

// ==================== QUESTS ====================
function syncQ(d){
  let ch=false;
  Object.keys(d.quests).forEach(qid=>{
    const qd=QDEFS.find(x=>x.id===qid);if(!qd)return;
    const q=d.quests[qid];if(q.claimed)return;
    const val=d.qs[qd.stat]||0;
    const prog=Math.min(qd.goal,val);
    if(prog!==q.prog){q.prog=prog;ch=true;}
  });
  if(ch)S.set(me,d);
}

function openQuests(){
  let d=S.get(me);d=fix(d);syncQ(d);
  // gifts
  const gs=document.getElementById("giftSection");
  if(d.gifts&&d.gifts.length>0){
    gs.style.display="block";
    gs.innerHTML=`<div class="section-title">üéÅ Y√ñNETƒ∞Cƒ∞ HEDƒ∞YELERƒ∞</div>`+
      d.gifts.map((g,i)=>`
        <div class="gift-card">
          <div class="gift-icon">üéÅ</div>
          <div class="gift-info">
            <div class="gift-title">üëë <b>${OWN_U}</b> size hediye g√∂nderdi!</div>
            <div class="gift-msg">${g.message}</div>
          </div>
          <button class="gift-claim-btn" onclick="claimGift(${i})">‚úì Aldƒ±m!</button>
        </div>`).join("");
  }else{gs.style.display="none";gs.innerHTML="";}
  // quests
  const el=document.getElementById("questList");el.innerHTML="";
  Object.keys(d.quests).forEach(qid=>{
    const qd=QDEFS.find(x=>x.id===qid);if(!qd)return;
    const q=d.quests[qid];
    const pct=Math.min(100,(q.prog/qd.goal)*100);
    const done=q.prog>=qd.goal;
    const c=document.createElement("div");c.className="quest-card"+(q.claimed?" claimed":"");
    c.innerHTML=`
      <span class="quest-icon">${qd.icon}</span>
      <div class="quest-info">
        <div class="quest-name">${qd.name}</div>
        <div class="quest-desc">${qd.desc}</div>
        <div class="quest-prog-wrap"><div class="quest-prog-fill" style="width:${pct}%"></div></div>
        <div class="quest-prog-text">${q.prog} / ${qd.goal}</div>
        ${done&&!q.claimed?`<button class="quest-claim-btn" onclick="claimQ('${qid}')">üí∞ +${qd.reward} Al!</button>`:""}
        ${q.claimed?`<div class="quest-done-lbl">‚úì Tamamlandƒ±</div>`:""}
      </div>
      <div class="quest-reward">üí∞ ${qd.reward}</div>`;
    el.appendChild(c);
  });
  const now=new Date(),mid=new Date(now);mid.setHours(24,0,0,0);
  const diff=mid-now,h=Math.floor(diff/3600000),m=Math.floor((diff%3600000)/60000);
  document.getElementById("questTimer").textContent=`üïê Yenilenmesine: ${h}s ${m}dk`;
  openM("questOverlay");
}

function claimGift(i){
  let d=S.get(me);d=fix(d);
  if(!d.gifts||i>=d.gifts.length)return;
  const g=d.gifts.splice(i,1)[0];
  if(g.type==="coin")d.coins=Number(d.coins)+Number(g.amount);
  if(g.type==="badge"&&!d.badges.includes(g.badgeId))d.badges.push(g.badgeId);
  if(g.type==="item"&&!d.specials.includes(g.itemId)){d.specials.push(g.itemId);sp[g.itemId]=true;if(g.itemId==="sp_light")colorLight=true;if(g.itemId==="sp_storm")storm=true;}
  S.set(me,d);updateUI();notif("üéÅ Hediye alƒ±ndƒ±!");openQuests();
}

function claimQ(qid){
  let d=S.get(me);d=fix(d);
  const qd=QDEFS.find(x=>x.id===qid);if(!qd)return;
  const q=d.quests[qid];
  if(!q||q.claimed||q.prog<qd.goal)return;
  q.claimed=true;
  d.coins=Number(d.coins)+Number(qd.reward);
  d.qDone=(d.qDone||0)+1;
  d.qs.coinsNow=Math.floor(d.coins);
  S.set(me,d);chkBadges(d);updateUI();notif(`üéâ +${qd.reward} coin!`);openQuests();
}

// ==================== SHOP ====================
function openShop(){renderShop();openM("shopOverlay");}
function setCat(c){
  curCat=c;
  document.querySelectorAll(".cat-btn").forEach((b,i)=>b.classList.toggle("active",["fish","decor","special"][i]===c));
  renderShop();
}
function renderShop(){
  let d=S.get(me);d=fix(d);
  const ul=isOwner?99:d.level;
  document.getElementById("shopCoins").textContent=isOwner?"‚àû":Math.floor(d.coins);
  document.getElementById("shopGrid").innerHTML=SHOP[curCat].map(item=>{
    const owned=curCat==="special"&&(d.specials||[]).includes(item.id);
    const locked=curCat==="fish"&&(item.minLvl||1)>ul;
    const canBuy=!owned&&!locked;
    const afford=isOwner||d.coins>=item.price;
    const speedT=item.speed?`<div class="sc-speed">‚ö° ${item.speed}</div>`:"";
    const lockT=locked?`<div class="sc-req">üîí Seviye ${item.minLvl}</div>`:"";
    const priceS=locked?`Lv.${item.minLvl}`:isOwner?"‚àû":`üí∞ ${item.price}`;
    let btnLabel=owned?"‚úì Aktif":locked?"üîí Kilitli":!afford?`‚ùå ${item.price} gerekli`:"Satƒ±n Al";
    let btnCls="card-btn"+(owned?" owned":"");
    let onclick="";
    if(canBuy && afford){
      if(curCat==="fish")onclick=`buyFish("${item.id}")`;
      else if(curCat==="decor")onclick=`buyDecor("${item.id}")`;
      else onclick=`buySpecial("${item.id}")`;
    }
    return`<div class="shop-card ${item.rarity||""} ${locked?"locked":""}">
      <span class="sc-icon">${item.emoji}</span>
      <div class="sc-name">${item.name}</div>
      <div class="sc-desc">${item.desc||""}</div>
      ${speedT}${lockT}
      <div class="sc-price">${priceS}</div>
      <button class="${btnCls}" ${onclick?`onclick="${onclick}"`:canBuy?"":"disabled"}>${btnLabel}</button>
    </div>`;
  }).join("");
}

function buyFish(type){
  let d=S.get(me);d=fix(d);
  const item=SHOP.fish.find(x=>x.id===type);if(!item)return;
  const ul=isOwner?99:d.level;
  if((item.minLvl||1)>ul)return notif(`üîí Seviye ${item.minLvl} gerekli!`);
  if(!isOwner&&d.coins<item.price)return notif(`‚ùå Para yok! Gereken:${item.price} Sahip:${Math.floor(d.coins)}`);
  if(!isOwner)d.coins=Number(d.coins)-Number(item.price);
  const fp=FP[type]||FP.normal;
  const names=["Nemo","Dori","Splash","Goldie","Finley","Marina","Bubbles","Jaws","Wave","Coral","Lucky","Storm","Nova","Pearl","Finn"];
  d.fishCtr=(d.fishCtr||0)+1;
  const W=CV.width||800,H=CV.height||600;
  d.fish.push({id:d.fishCtr,type,name:names[Math.floor(Math.random()*names.length)]+d.fishCtr,x:120+Math.random()*(W-240),y:100+Math.random()*(H-240),vx:(Math.random()-.5)*fp.spd*2,vy:(Math.random()-.5)*.4,dir:Math.random()>.5?1:-1,ph:Math.random()*Math.PI*2,hunger:100});
  d.qs.buyCount=(d.qs.buyCount||0)+1;d.qs.fishCount=d.fish.length;
  S.set(me,d);chkBadges(d);syncQ(d);updateUI();notif(`${item.emoji} ${item.name} eklendi!`);renderShop();
}

function buyDecor(type){
  let d=S.get(me);d=fix(d);
  const item=SHOP.decor.find(x=>x.id===type);if(!item)return;
  if(!isOwner&&d.coins<item.price)return notif(`‚ùå Para yok! Gereken:${item.price} Sahip:${Math.floor(d.coins)}`);
  if(!isOwner)d.coins=Number(d.coins)-Number(item.price);
  const W=CV.width||800,H=CV.height||600;
  d.decors.push({type,emoji:item.emoji,x:60+Math.random()*(W-120),y:H-42-Math.random()*22,sz:24+Math.random()*10});
  d.qs.decorCount=(d.qs.decorCount||0)+1;
  S.set(me,d);syncQ(d);updateUI();notif(`${item.emoji} ${item.name} eklendi!`);renderShop();
}

function buySpecial(type){
  let d=S.get(me);d=fix(d);
  const item=SHOP.special.find(x=>x.id===type);if(!item)return;
  if((d.specials||[]).includes(type))return notif("Zaten sahipsin!");
  if(!isOwner&&d.coins<item.price)return notif(`‚ùå Para yok! Gereken:${item.price} Sahip:${Math.floor(d.coins)}`);
  if(!isOwner)d.coins=Number(d.coins)-Number(item.price);
  d.specials.push(type);S.set(me,d);
  sp[type]=true;
  if(type==="sp_feed")startAutoFeed();
  if(type==="sp_light")colorLight=true;
  if(type==="sp_storm")storm=true;
  updateUI();notif(`${item.emoji} Aktif!`);renderShop();
}

// ==================== LEVEL ====================
function getLvl(xp){
  let cur=LVL[0];
  for(let i=0;i<LVL.length;i++){if(xp>=LVL[i].xp)cur=LVL[i];}
  return{cur,next:LVL.find(l=>l.xp>xp)};
}
function showLvlUp(lvl){
  const li=LVL.find(l=>l.l===lvl)||LVL[LVL.length-1];
  const el=document.createElement("div");el.className="levelup";
  el.innerHTML=`<h2 style="font-family:'Orbitron',monospace;font-size:11px;color:var(--accent2);letter-spacing:3px;margin-bottom:12px">‚≠ê SEVƒ∞YE ATLADIN!</h2>
    <span class="bp-icon">üéâ</span>
    <div class="bp-name-g">Seviye ${lvl}</div>
    <div class="bp-desc">${li.n}</div>
    <button class="popup-btn-g" onclick="this.parentElement.remove();renderShop()">Harika!</button>`;
  document.body.appendChild(el);
}

// ==================== BADGES ====================
function chkBadges(d){
  const n=d.fish.length,b=d.badges;let got=null;
  if(n>=1&&!b.includes("first_fish")){b.push("first_fish");got=BADGES.find(x=>x.id==="first_fish");}
  if(n>=13&&!b.includes("beta")){b.push("beta");got=BADGES.find(x=>x.id==="beta");}
  if(n>=20&&!b.includes("master")){b.push("master");got=BADGES.find(x=>x.id==="master");}
  if(!isOwner&&d.coins>=1000&&!b.includes("rich")){b.push("rich");got=BADGES.find(x=>x.id==="rich");}
  if(new Set(d.fish.map(f=>f.type)).size>=8&&!b.includes("collector")){b.push("collector");got=BADGES.find(x=>x.id==="collector");}
  if(d.level>=7&&!b.includes("max_level")){b.push("max_level");got=BADGES.find(x=>x.id==="max_level");}
  if((d.qDone||0)>=10&&!b.includes("quest_hero")){b.push("quest_hero");got=BADGES.find(x=>x.id==="quest_hero");}
  if(got){S.set(me,d);showBadge(got);}
}
function showBadge(b){
  const el=document.createElement("div");el.className="badge-popup";
  el.innerHTML=`<h2 style="font-family:'Orbitron',monospace;font-size:11px;color:var(--gold);letter-spacing:3px;margin-bottom:12px">üéâ ROZET KAZANDIN!</h2>
    <span class="bp-icon">${b.icon}</span>
    <div class="bp-name">${b.name}</div>
    <div class="bp-desc">${b.desc}</div>
    <button class="popup-btn" onclick="this.parentElement.remove()">Harika!</button>`;
  document.body.appendChild(el);
}

// ==================== OWNER ====================
let oUsers=[];
function openOwner(){
  oUsers=Object.keys(S.all()).filter(u=>u!==OWN_U);
  oTab("badge");openM("ownerOverlay");
}
function oTab(tab){
  curOTab=tab;
  document.querySelectorAll(".owner-tab").forEach((b,i)=>b.classList.toggle("active",["badge","coin","item"][i]===tab));
  renderOwner();
}
function renderOwner(){
  const el=document.getElementById("ownerContent");
  if(!oUsers.length){el.innerHTML='<div style="color:rgba(200,240,255,.32);font-size:13px;text-align:center;padding:20px">Kayƒ±tlƒ± kullanƒ±cƒ± yok</div>';return;}
  el.innerHTML=oUsers.map(un=>{
    const ud=S.get(un);
    const av=AVATARS[(ud&&ud.avatar)||"nemo"]||AVATARS.nemo;
    const coins=Math.floor((ud&&ud.coins)||0);
    const lvl=(ud&&ud.level)||1;
    const fish=(ud&&ud.fish&&ud.fish.length)||0;
    const top=`<div class="u-row-top"><img class="u-av" src="${av}" alt><div class="u-info"><div class="u-name">${un}</div><div class="u-stats">Lv.${lvl} ¬∑ ${fish} balƒ±k ¬∑ üí∞${coins}</div></div></div>`;
    if(curOTab==="badge"){
      const manual=BADGES.filter(b=>!b.auto);
      return`<div class="u-row">${top}<select class="o-select" id="bs_${un}">${manual.map(b=>`<option value="${b.id}">${b.icon} ${b.name}</option>`).join("")}</select><button class="o-btn o-btn-gold" onclick="sendBadge('${un}')">üèÖ Rozet G√∂nder</button></div>`;
    }
    if(curOTab==="coin")return`<div class="u-row">${top}<input class="o-input" id="ca_${un}" type="number" placeholder="Coin miktarƒ±" min="1"><button class="o-btn o-btn-gold" onclick="sendCoin('${un}')">üí∞ G√∂nder</button></div>`;
    if(curOTab==="item")return`<div class="u-row">${top}<select class="o-select" id="is_${un}">${SHOP.special.map(s=>`<option value="${s.id}">${s.emoji} ${s.name}</option>`).join("")}</select><button class="o-btn o-btn-green" onclick="sendItem('${un}')">üéÅ Item G√∂nder</button></div>`;
    return"";
  }).join("");
}
function sendBadge(un){
  const sel=document.getElementById(`bs_${un}`);if(!sel)return;
  const bid=sel.value;const d=S.get(un);if(!d)return;
  if(!d.badges)d.badges=[];
  if(d.badges.includes(bid))return notif("‚ö†Ô∏è Bu rozet zaten var!");
  const bdef=BADGES.find(x=>x.id===bid);
  if(!d.gifts)d.gifts=[];
  d.gifts.push({type:"badge",badgeId:bid,message:`üèÖ <b>${bdef?.icon} ${bdef?.name}</b> rozeti hediye edildi!`});
  d.badges.push(bid);S.set(un,d);notif(`‚úÖ ${un} kullanƒ±cƒ±sƒ±na rozet g√∂nderildi!`);
}
function sendCoin(un){
  const inp=document.getElementById(`ca_${un}`);if(!inp)return;
  const amount=parseInt(inp.value)||0;
  if(amount<=0)return notif("‚ùå Ge√ßersiz miktar!");
  const d=S.get(un);if(!d)return;
  if(!d.gifts)d.gifts=[];
  d.gifts.push({type:"coin",amount,message:`üí∞ <b>${amount} coin</b> hediye edildi!`});
  d.coins=Number(d.coins)+Number(amount);
  S.set(un,d);inp.value="";notif(`‚úÖ ${un} kullanƒ±cƒ±sƒ±na ${amount} coin g√∂nderildi!`);
}
function sendItem(un){
  const sel=document.getElementById(`is_${un}`);if(!sel)return;
  const itemId=sel.value;const d=S.get(un);if(!d)return;
  if((d.specials||[]).includes(itemId))return notif("‚ö†Ô∏è Bu item zaten var!");
  const idef=SHOP.special.find(x=>x.id===itemId);
  if(!d.gifts)d.gifts=[];
  d.gifts.push({type:"item",itemId,message:`${idef?.emoji} <b>${idef?.name}</b> √∂zel e≈üyasƒ± hediye edildi!`});
  if(!d.specials)d.specials=[];d.specials.push(itemId);
  S.set(un,d);notif(`‚úÖ ${un} kullanƒ±cƒ±sƒ±na ${idef?.name} g√∂nderildi!`);
}

// ==================== UI ====================
function updateUI(){
  let d=S.get(me);if(!d)return;d=fix(d);
  const{cur,next}=getLvl(d.xp);
  document.getElementById("tCoins").textContent=isOwner?"‚àû":Math.floor(d.coins);
  document.getElementById("tLevel").textContent=isOwner?"MAX":d.level;
  document.getElementById("sLevel").textContent=isOwner?"MAX":d.level;
  document.getElementById("sLevelName").textContent=isOwner?"Kurucu":cur.n;
  if(next&&!isOwner){const p=Math.min(100,((d.xp-cur.xp)/(next.xp-cur.xp))*100);document.getElementById("xpBar").style.width=p+"%";document.getElementById("xpLabel").textContent=`${d.xp} / ${next.xp} XP`;}
  else{document.getElementById("xpBar").style.width="100%";document.getElementById("xpLabel").textContent="MAX üî±";}
  document.getElementById("sFishCount").textContent=d.fish.length;
  const fl=document.getElementById("sFishList");
  fl.innerHTML=d.fish.length===0?'<div class="no-content">Hen√ºz balƒ±k yok</div>':
    d.fish.map(f=>{const h=f.hunger||0;const c=h>60?"#00ff9d":h>30?"#ffaa00":"#ff4444";const fd=SHOP.fish.find(x=>x.id===f.type)||SHOP.fish[0];
      return`<div class="fish-row"><span>${fd.emoji}</span><span style="flex:1">${f.name}</span><div class="hunger-bar"><div class="hunger-fill" style="width:${h}%;background:${c}"></div></div></div>`;
    }).join("");
  const be=document.getElementById("sBadges");const bs=d.badges||[];
  be.innerHTML=bs.length===0?'<div class="no-content">Hen√ºz rozet yok</div>':
    bs.map(bid=>{const b=BADGES.find(x=>x.id===bid);return b?`<span class="badge-chip">${b.icon} ${b.name}</span>`:""}).join("");
}
function notif(text){const el=document.createElement("div");el.className="notif";el.textContent=text;document.body.appendChild(el);setTimeout(()=>el.remove(),3000);}

document.addEventListener("keydown",e=>{
  if(e.key!=="Enter")return;
  if(document.getElementById("loginForm").style.display!=="none")doLogin();
  else if(document.getElementById("registerForm").style.display!=="none")doRegister();
  else if(document.getElementById("founderForm").style.display!=="none")doFounderLogin();
});

</script>
</body>
</html>
