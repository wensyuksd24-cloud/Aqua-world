<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' data: blob:;">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>Aqua World</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&family=Orbitron:wght@700;900&display=swap');
:root{--deep:#020e1f;--accent:#00d4ff;--accent2:#00ff9d;--gold:#ffd700;--coral:#ff6b6b;--text:#c8f0ff;}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{font-family:'Quicksand',sans-serif;background:var(--deep);color:var(--text);height:100vh;overflow:hidden;}
::-webkit-scrollbar{width:4px;}::-webkit-scrollbar-thumb{background:rgba(0,212,255,.25);border-radius:2px;}
#authScreen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:1000;overflow-y:auto;padding:16px;background-size:cover;background-position:center;}
#authScreen::before{content:'';position:absolute;inset:0;background:rgba(0,5,20,.52);}
.auth-box{position:relative;z-index:2;background:rgba(2,12,35,.88);border:2px solid var(--accent);border-radius:14px;padding:26px 28px;width:100%;max-width:390px;backdrop-filter:blur(18px);box-shadow:0 0 40px rgba(0,212,255,.3),inset 0 0 24px rgba(0,212,255,.04);clip-path:polygon(10px 0%,calc(100% - 10px) 0%,100% 10px,100% calc(100% - 10px),calc(100% - 10px) 100%,10px 100%,0% calc(100% - 10px),0% 10px);animation:fadeUp .5s ease;}
.auth-logo{text-align:center;margin-bottom:16px;}
.auth-fish-img{width:52px;filter:drop-shadow(0 0 10px var(--accent));animation:swimLogo 3s ease-in-out infinite;}
@keyframes swimLogo{0%,100%{transform:translateX(-6px) rotate(-3deg);}50%{transform:translateX(6px) rotate(3deg);}}
.auth-logo h1{font-family:'Orbitron',monospace;font-size:19px;color:var(--accent);text-shadow:0 0 18px var(--accent);letter-spacing:4px;margin-top:5px;}
.tabs{display:flex;margin-bottom:14px;border:1px solid rgba(0,212,255,.28);border-radius:8px;overflow:hidden;}
.tab-btn{flex:1;padding:9px;border:none;background:transparent;color:rgba(200,240,255,.4);cursor:pointer;font-family:'Quicksand',sans-serif;font-size:13px;font-weight:700;transition:all .3s;letter-spacing:1px;}
.tab-btn.active{background:rgba(0,212,255,.18);color:var(--accent);}
.tab-btn:first-child{border-right:1px solid rgba(0,212,255,.28);}
.auth-input{width:100%;padding:10px 13px;background:rgba(0,0,0,.5);border:1px solid rgba(0,212,255,.22);border-radius:8px;color:var(--text);font-family:'Quicksand',sans-serif;font-size:14px;margin-bottom:9px;outline:none;transition:border-color .3s;}
.auth-input:focus{border-color:var(--accent);}
.auth-btn{width:100%;padding:11px;background:transparent;border:1px solid var(--accent);border-radius:8px;color:var(--accent);font-family:'Quicksand',sans-serif;font-size:14px;font-weight:700;cursor:pointer;letter-spacing:2px;margin-top:3px;transition:all .3s;}
.auth-btn:hover{background:rgba(0,212,255,.13);}
.founder-btn{width:100%;padding:9px;background:rgba(255,215,0,.08);border:1px solid rgba(255,215,0,.38);border-radius:8px;color:var(--gold);font-family:'Quicksand',sans-serif;font-size:13px;font-weight:700;cursor:pointer;margin-top:8px;}
.back-btn{width:100%;padding:9px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.1);border-radius:8px;color:rgba(200,240,255,.45);font-family:'Quicksand',sans-serif;font-size:13px;cursor:pointer;margin-top:8px;}
.auth-msg{font-size:12px;text-align:center;margin-top:8px;min-height:16px;}
.auth-msg.err{color:var(--coral);}.auth-msg.ok{color:var(--accent2);}
.dev-tag{text-align:center;font-size:11px;color:rgba(200,240,255,.18);margin-top:12px;}
.av-pick-title{font-size:11px;color:var(--accent);letter-spacing:1px;text-align:center;margin-bottom:7px;font-weight:700;}
.avatar-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:7px;margin-bottom:11px;}
.av-option{border:2px solid rgba(0,212,255,.18);border-radius:50%;overflow:hidden;cursor:pointer;aspect-ratio:1;background:rgba(0,0,0,.3);transition:all .25s;}
.av-option img{width:100%;height:100%;object-fit:cover;display:block;}
.av-option.selected,.av-option:hover{border-color:var(--accent);box-shadow:0 0 14px rgba(0,212,255,.45);}

#gameScreen{display:none;position:fixed;inset:0;}
#aquariumCanvas{position:absolute;top:0;left:0;width:100%;height:100%;cursor:crosshair;}
.top-bar-wrap{position:absolute;top:0;left:0;right:0;height:54px;background:linear-gradient(180deg,rgba(1,7,22,.97),rgba(1,7,22,.45));z-index:10;overflow:hidden;}
.top-bar{display:flex;align-items:center;padding:0 12px;gap:7px;height:54px;overflow-x:auto;overflow-y:hidden;-webkit-overflow-scrolling:touch;scrollbar-width:none;}
.top-bar::-webkit-scrollbar{display:none;}
.top-fade-l{position:absolute;left:0;top:0;width:22px;height:54px;background:linear-gradient(90deg,rgba(1,7,22,.97),transparent);pointer-events:none;z-index:1;}
.top-fade-r{position:absolute;right:0;top:0;width:22px;height:54px;background:linear-gradient(270deg,rgba(1,7,22,.97),transparent);pointer-events:none;z-index:1;}
.top-title{font-family:'Orbitron',monospace;font-size:12px;color:var(--accent);text-shadow:0 0 12px var(--accent);letter-spacing:2px;flex-shrink:0;}
.user-pill{display:flex;align-items:center;gap:7px;background:rgba(0,0,0,.45);border:1px solid rgba(0,212,255,.18);border-radius:20px;padding:3px 11px 3px 3px;flex-shrink:0;cursor:pointer;transition:border-color .2s;}
.user-pill:hover{border-color:var(--accent);}
.user-av{width:30px;height:30px;border-radius:50%;border:1px solid var(--accent);object-fit:cover;}
.user-name{font-size:12px;font-weight:700;}
.badge-owner{background:linear-gradient(135deg,var(--gold),#c06000);color:#000;font-size:10px;font-weight:700;padding:2px 6px;border-radius:9px;}
.badge-dev{background:linear-gradient(135deg,#f0f,#70c);color:#fff;font-size:10px;font-weight:700;padding:2px 6px;border-radius:9px;}
.coin-pill{display:flex;align-items:center;gap:5px;background:rgba(0,0,0,.45);border:1px solid rgba(255,215,0,.2);border-radius:20px;padding:5px 11px;font-size:13px;font-weight:700;color:var(--gold);flex-shrink:0;}
.level-pill{display:flex;align-items:center;gap:5px;background:rgba(0,0,0,.45);border:1px solid rgba(0,255,157,.2);border-radius:20px;padding:5px 11px;font-size:12px;font-weight:700;color:var(--accent2);flex-shrink:0;}
.top-gap{flex:1;min-width:6px;}
.top-btn{background:rgba(0,0,0,.4);border:1px solid rgba(0,212,255,.2);border-radius:18px;padding:6px 12px;color:var(--text);cursor:pointer;font-family:'Quicksand',sans-serif;font-size:11px;font-weight:700;flex-shrink:0;white-space:nowrap;}
.top-btn:hover{border-color:var(--accent);color:var(--accent);}
.shop-btn{background:linear-gradient(135deg,rgba(0,212,255,.2),rgba(0,212,255,.06));border:1px solid rgba(0,212,255,.35);border-radius:18px;padding:6px 15px;color:var(--accent);cursor:pointer;font-family:'Quicksand',sans-serif;font-size:11px;font-weight:700;flex-shrink:0;}
.quest-btn{background:linear-gradient(135deg,rgba(255,215,0,.18),rgba(255,140,0,.08));border:1px solid rgba(255,215,0,.32);border-radius:18px;padding:6px 13px;color:var(--gold);cursor:pointer;font-family:'Quicksand',sans-serif;font-size:11px;font-weight:700;flex-shrink:0;}
.side-panel{position:absolute;right:0;top:54px;bottom:0;width:238px;background:linear-gradient(180deg,rgba(1,8,26,.98),rgba(1,4,14,.99));border-left:1px solid rgba(0,212,255,.07);z-index:10;display:flex;flex-direction:column;overflow-y:auto;padding:10px;gap:9px;}
@media(max-width:680px){.side-panel{display:none;}}
.ps{background:rgba(0,0,0,.28);border:1px solid rgba(0,212,255,.08);border-radius:11px;padding:10px;}
.ps-title{font-size:10px;font-weight:700;color:var(--accent);letter-spacing:2px;margin-bottom:7px;text-transform:uppercase;}
.fish-row{display:flex;align-items:center;gap:6px;padding:4px 6px;border-radius:7px;background:rgba(0,0,0,.2);margin-bottom:3px;font-size:11px;}
.hunger-bar{flex:1;height:4px;background:rgba(255,255,255,.07);border-radius:2px;overflow:hidden;}
.hunger-fill{height:100%;border-radius:2px;transition:width .5s;}
.badge-chip{display:inline-flex;align-items:center;gap:3px;background:rgba(0,0,0,.28);border:1px solid rgba(255,215,0,.18);border-radius:18px;padding:2px 7px;font-size:10px;margin:2px;color:var(--gold);}
.xp-bar-wrap{background:rgba(0,0,0,.28);border-radius:3px;height:5px;margin-top:5px;overflow:hidden;}
.xp-bar-fill{height:100%;background:linear-gradient(90deg,var(--accent2),var(--accent));border-radius:3px;transition:width .6s;}
.xp-label{font-size:10px;color:rgba(200,240,255,.38);margin-top:3px;}
.weather-row{display:flex;align-items:center;gap:7px;padding:6px 8px;background:rgba(0,0,0,.18);border-radius:8px;font-size:11px;}
.no-content{font-size:11px;color:rgba(200,240,255,.28);}

.overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:200;display:none;align-items:center;justify-content:center;backdrop-filter:blur(6px);padding:14px;}
.overlay.open{display:flex;}
.modal{background:linear-gradient(145deg,#040f28,#020918);border-radius:20px;width:100%;max-height:92vh;overflow:hidden;display:flex;flex-direction:column;animation:fadeUp .35s ease;}
.modal-hdr{display:flex;align-items:center;padding:16px 20px 11px;border-bottom:1px solid rgba(0,212,255,.07);flex-shrink:0;}
.modal-hdr h2{font-family:'Orbitron',monospace;font-size:13px;letter-spacing:2px;flex:1;}
.modal-x{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:50%;width:30px;height:30px;color:var(--text);cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.modal-x:hover{background:rgba(255,80,80,.2);color:var(--coral);}
.modal-body{flex:1;overflow-y:auto;padding:13px 20px 20px;}
#shopModal{border:1px solid rgba(0,212,255,.2);max-width:760px;}
.shop-coins{font-size:13px;font-weight:700;color:var(--gold);margin-right:12px;}
.shop-cats{display:flex;gap:6px;padding:9px 20px 0;flex-shrink:0;overflow-x:auto;}
.cat-btn{padding:7px 15px;border-radius:18px;border:1px solid rgba(0,212,255,.16);background:transparent;color:rgba(200,240,255,.42);cursor:pointer;font-family:'Quicksand',sans-serif;font-size:12px;font-weight:700;flex-shrink:0;transition:all .25s;}
.cat-btn.active{background:rgba(0,212,255,.14);border-color:var(--accent);color:var(--accent);}
.shop-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(155px,1fr));gap:10px;padding-top:11px;}
.shop-card{background:rgba(0,0,0,.32);border:1px solid rgba(0,212,255,.1);border-radius:13px;padding:13px 10px;text-align:center;transition:all .25s;position:relative;overflow:hidden;}
.shop-card:hover:not(.locked){border-color:rgba(0,212,255,.28);transform:translateY(-2px);}
.shop-card.rare{border-color:rgba(255,215,0,.2);}
.shop-card.rare::after{content:'‚òÖ NADƒ∞R';position:absolute;top:7px;right:7px;font-size:9px;color:var(--gold);font-weight:700;}
.shop-card.epic{border-color:rgba(180,0,255,.25);}
.shop-card.epic::after{content:'‚óÜ EPƒ∞K';position:absolute;top:7px;right:7px;font-size:9px;color:#cc88ff;font-weight:700;}
.shop-card.locked{opacity:.48;filter:grayscale(.5);}
.sc-icon{font-size:38px;display:block;margin-bottom:6px;line-height:1;}
.sc-name{font-size:12px;font-weight:700;margin-bottom:2px;}
.sc-desc{font-size:10px;color:rgba(200,240,255,.38);margin-bottom:5px;line-height:1.4;}
.sc-speed{font-size:10px;color:rgba(200,240,255,.26);margin-bottom:4px;}
.sc-price{font-size:13px;font-weight:700;color:var(--gold);margin-bottom:8px;}
.sc-req{font-size:10px;color:rgba(255,180,0,.55);margin-bottom:4px;}
.card-btn{width:100%;padding:8px;background:linear-gradient(135deg,rgba(0,212,255,.18),rgba(0,212,255,.07));border:1px solid rgba(0,212,255,.28);border-radius:8px;color:var(--accent);font-family:'Quicksand',sans-serif;font-size:12px;font-weight:700;cursor:pointer;transition:all .22s;}
.card-btn:hover{background:linear-gradient(135deg,rgba(0,212,255,.32),rgba(0,212,255,.16));}
.card-btn.owned{opacity:.45;cursor:default;background:rgba(0,255,157,.07);border-color:rgba(0,255,157,.3);color:var(--accent2);}
.card-btn.cant{opacity:.38;cursor:not-allowed;border-color:rgba(255,80,80,.3);color:rgba(255,120,120,.7);}
#questModal{border:1px solid rgba(255,215,0,.22);max-width:510px;}
.sec-title{font-size:10px;font-weight:700;color:var(--gold);letter-spacing:2px;text-transform:uppercase;margin-bottom:8px;margin-top:4px;}
.gift-card{background:linear-gradient(135deg,rgba(255,215,0,.1),rgba(255,140,0,.05));border:1px solid rgba(255,215,0,.3);border-radius:12px;padding:12px;margin-bottom:9px;display:flex;align-items:flex-start;gap:10px;}
.gift-icon{font-size:24px;flex-shrink:0;}
.gift-info{flex:1;}
.gift-title{font-size:12px;font-weight:700;color:var(--gold);margin-bottom:3px;}
.gift-msg{font-size:11px;color:rgba(200,240,255,.55);line-height:1.5;}
.gift-claim-btn{background:linear-gradient(135deg,var(--gold),#cc8800);color:#000;border:none;padding:6px 13px;border-radius:16px;font-family:'Quicksand',sans-serif;font-size:11px;font-weight:700;cursor:pointer;margin-top:7px;display:block;}
.quest-card{background:rgba(0,0,0,.3);border:1px solid rgba(255,215,0,.1);border-radius:12px;padding:12px;margin-bottom:8px;display:flex;align-items:flex-start;gap:10px;}
.quest-card.claimed{border-color:rgba(0,255,157,.25);background:rgba(0,255,157,.03);}
.quest-icon{font-size:24px;flex-shrink:0;margin-top:2px;}
.quest-info{flex:1;}
.quest-name{font-size:13px;font-weight:700;margin-bottom:2px;}
.quest-desc{font-size:11px;color:rgba(200,240,255,.4);}
.quest-prog-wrap{background:rgba(0,0,0,.28);border-radius:3px;height:4px;margin-top:5px;overflow:hidden;}
.quest-prog-fill{height:100%;background:linear-gradient(90deg,var(--gold),#ff8800);border-radius:3px;transition:width .5s;}
.quest-prog-text{font-size:10px;color:rgba(200,240,255,.3);margin-top:2px;}
.quest-reward{font-size:12px;font-weight:700;color:var(--gold);flex-shrink:0;}
.quest-claim-btn{background:linear-gradient(135deg,var(--gold),#cc8800);color:#000;border:none;padding:6px 12px;border-radius:15px;font-family:'Quicksand',sans-serif;font-size:11px;font-weight:700;cursor:pointer;margin-top:5px;display:block;}
.quest-done-lbl{font-size:11px;color:var(--accent2);margin-top:4px;}
.quest-timer{font-size:11px;color:rgba(200,240,255,.32);text-align:center;padding:8px 0;}
#profileModal{border:1px solid rgba(0,212,255,.2);max-width:400px;}
.profile-av-big{width:110px;height:110px;border-radius:50%;border:3px solid var(--accent);object-fit:cover;display:block;margin:0 auto 12px;box-shadow:0 0 26px rgba(0,212,255,.28);}
.profile-username{text-align:center;font-family:'Orbitron',monospace;font-size:15px;color:var(--accent);letter-spacing:2px;margin-bottom:3px;}
.profile-level{text-align:center;font-size:12px;color:var(--accent2);margin-bottom:13px;}
.profile-stats{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:13px;}
.stat-box{background:rgba(0,0,0,.28);border:1px solid rgba(0,212,255,.1);border-radius:9px;padding:9px;text-align:center;}
.stat-val{font-size:17px;font-weight:700;color:var(--accent);}
.stat-lbl{font-size:10px;color:rgba(200,240,255,.38);margin-top:2px;}
.profile-sec{font-size:10px;font-weight:700;color:var(--gold);letter-spacing:2px;text-transform:uppercase;margin-bottom:7px;}
.profile-badges{display:flex;flex-wrap:wrap;gap:5px;}
.pb-item{display:flex;align-items:center;gap:4px;background:rgba(0,0,0,.28);border:1px solid rgba(255,215,0,.18);border-radius:16px;padding:4px 9px;font-size:11px;color:var(--gold);}
#ownerModal{border:2px solid var(--gold);max-width:490px;}
.owner-tabs{display:flex;gap:4px;margin-bottom:13px;background:rgba(0,0,0,.32);border-radius:9px;padding:4px;}
.owner-tab{flex:1;padding:7px;border:none;border-radius:6px;background:transparent;color:rgba(200,240,255,.38);cursor:pointer;font-family:'Quicksand',sans-serif;font-size:11px;font-weight:700;transition:all .25s;}
.owner-tab.active{background:rgba(255,215,0,.14);color:var(--gold);}
.u-row{background:rgba(0,0,0,.28);border:1px solid rgba(255,215,0,.1);border-radius:10px;padding:10px;margin-bottom:7px;}
.u-row-top{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
.u-av{width:36px;height:36px;border-radius:50%;border:1px solid rgba(255,215,0,.35);object-fit:cover;}
.u-info{flex:1;}.u-name{font-size:13px;font-weight:700;}.u-stats{font-size:10px;color:rgba(200,240,255,.38);}
.o-select{background:rgba(0,0,0,.38);border:1px solid rgba(255,215,0,.18);border-radius:8px;color:var(--gold);padding:8px;font-family:'Quicksand',sans-serif;font-size:12px;width:100%;margin-bottom:7px;outline:none;}
.o-input{width:100%;padding:9px 12px;background:rgba(0,0,0,.38);border:1px solid rgba(255,215,0,.18);border-radius:8px;color:var(--text);font-family:'Quicksand',sans-serif;font-size:12px;margin-bottom:7px;outline:none;}
.o-input:focus,.o-select:focus{border-color:var(--gold);}
.o-btn{padding:7px 14px;border-radius:8px;border:1px solid;font-family:'Quicksand',sans-serif;font-size:11px;font-weight:700;cursor:pointer;}
.o-btn-gold{border-color:var(--gold);color:var(--gold);background:rgba(255,215,0,.08);}
.o-btn-green{border-color:var(--accent2);color:var(--accent2);background:rgba(0,255,157,.07);}
.feed-pt{position:fixed;pointer-events:none;font-size:17px;z-index:50;animation:ptFall 1s ease forwards;}
@keyframes ptFall{0%{transform:translateY(0) scale(1);opacity:1;}100%{transform:translateY(55px) scale(.1);opacity:0;}}
.notif{position:fixed;bottom:65px;left:50%;transform:translateX(-50%);background:rgba(0,14,38,.97);border:1px solid var(--accent);border-radius:12px;padding:10px 20px;font-size:13px;font-weight:600;color:var(--text);z-index:999;backdrop-filter:blur(10px);animation:notifA 3s ease forwards;white-space:nowrap;pointer-events:none;max-width:90vw;overflow:hidden;text-overflow:ellipsis;}
@keyframes notifA{0%{opacity:0;transform:translateX(-50%) translateY(16px);}12%{opacity:1;transform:translateX(-50%) translateY(0);}80%{opacity:1;}100%{opacity:0;transform:translateX(-50%) translateY(-8px);}}
.badge-popup,.levelup{position:fixed;top:50%;left:50%;border-radius:20px;padding:30px 40px;text-align:center;z-index:500;animation:popA .42s cubic-bezier(.175,.885,.32,1.275);max-width:88vw;}
.badge-popup{background:radial-gradient(ellipse,rgba(10,24,55,.99),rgba(2,5,14,.99));border:2px solid var(--gold);transform:translate(-50%,-50%);}
.levelup{background:radial-gradient(ellipse,rgba(0,36,26,.99),rgba(2,5,14,.99));border:2px solid var(--accent2);transform:translate(-50%,-50%);}
@keyframes popA{0%{opacity:0;transform:translate(-50%,-50%) scale(.4);}100%{opacity:1;transform:translate(-50%,-50%) scale(1);}}
.bp-icon{font-size:52px;display:block;margin-bottom:10px;}
.bp-gold{font-size:18px;font-weight:700;color:var(--gold);}
.bp-green{font-size:18px;font-weight:700;color:var(--accent2);}
.bp-desc{font-size:12px;color:rgba(200,240,255,.55);margin-top:5px;}
.popup-btn{margin-top:16px;background:linear-gradient(135deg,var(--gold),#aa6000);color:#000;border:none;padding:8px 24px;border-radius:18px;font-family:'Quicksand',sans-serif;font-size:13px;font-weight:700;cursor:pointer;}
.popup-btn-g{margin-top:16px;background:linear-gradient(135deg,var(--accent2),#008844);color:#000;border:none;padding:8px 24px;border-radius:18px;font-family:'Quicksand',sans-serif;font-size:13px;font-weight:700;cursor:pointer;}
@keyframes fadeUp{from{opacity:0;transform:translateY(18px);}to{opacity:1;transform:translateY(0);}}
</style>
</head>
<body>
<div id="authScreen" style="background-image:url('./login_bg.jpg')">
  <div class="auth-box">
    <div class="auth-logo"><img class="auth-fish-img" src="./av_nemo.png" alt><h1>AQUA WORLD</h1></div>
    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('login')">Gƒ∞Rƒ∞≈û YAP</button>
      <button class="tab-btn" onclick="switchTab('register')">KAYIT OL</button>
    </div>
    <div id="loginForm">
      <input class="auth-input" id="lUser" placeholder="Kullanƒ±cƒ± Adƒ±" type="text" autocomplete="username">
      <input class="auth-input" id="lPass" placeholder="≈ûifre" type="password" autocomplete="current-password">
      <button class="auth-btn" onclick="doLogin()">Gƒ∞Rƒ∞≈û YAP</button>
      <button class="founder-btn" onclick="showFounder()">üëë KURUCU PANELƒ∞</button>
    </div>
    <div id="founderForm" style="display:none">
      <input class="auth-input" id="fPass" placeholder="Kurucu ≈ûifresi" type="password">
      <button class="auth-btn" style="border-color:var(--gold);color:var(--gold)" onclick="doFounderLogin()">üëë Gƒ∞Rƒ∞≈û YAP</button>
      <button class="back-btn" onclick="hideFounder()">‚Üê Geri</button>
    </div>
    <div id="registerForm" style="display:none">
      <input class="auth-input" id="rUser" placeholder="Kullanƒ±cƒ± Adƒ±" type="text" autocomplete="username">
      <input class="auth-input" id="rPass" placeholder="≈ûifre" type="password" autocomplete="new-password">
      <input class="auth-input" id="rPass2" placeholder="≈ûifre Tekrar" type="password">
      <div class="av-pick-title">PROFƒ∞L FOTOƒûRAFI SE√á</div>
      <div class="avatar-grid">
        <div class="av-option selected" data-av="nemo" onclick="pickAv(this)"><img src="./av_nemo.png" alt></div>
        <div class="av-option" data-av="shark" onclick="pickAv(this)"><img src="./av_shark.png" alt></div>
        <div class="av-option" data-av="puffer" onclick="pickAv(this)"><img src="./av_puffer.png" alt></div>
        <div class="av-option" data-av="jellyfish" onclick="pickAv(this)"><img src="./av_jelly.png" alt></div>
        <div class="av-option" data-av="seahorse" onclick="pickAv(this)"><img src="./av_seahorse.png" alt></div>
        <div class="av-option" data-av="dolphin" onclick="pickAv(this)"><img src="./av_dolphin.png" alt></div>
      </div>
      <button class="auth-btn" onclick="doRegister()">KAYIT OL</button>
    </div>
    <div class="auth-msg" id="authMsg"></div>
    <div class="dev-tag">Geli≈ütirici: efeiswat</div>
  </div>
</div>
<div id="gameScreen">
  <canvas id="aquariumCanvas"></canvas>
  <div class="top-bar-wrap">
    <div class="top-fade-l"></div>
    <div class="top-bar">
      <span class="top-title">üåä AQUA WORLD</span>
      <div class="user-pill" onclick="openProfile()">
        <img class="user-av" id="tAvatar" src="./av_nemo.png" alt>
        <span id="tUser"></span>
        <span id="tOwner" class="badge-owner" style="display:none">KURUCU</span>
        <span id="tDev" class="badge-dev" style="display:none">GELƒ∞≈ûTƒ∞Rƒ∞Cƒ∞</span>
      </div>
      <div class="coin-pill">üí∞ <span id="tCoins">0</span></div>
      <div class="level-pill">‚≠ê Lv.<span id="tLevel">1</span></div>
      <div class="top-gap"></div>
      <button class="quest-btn" onclick="openQuests()">üìã G√∂revler</button>
      <button class="shop-btn" onclick="openShop()">üè™ D√ºkkan</button>
      <button class="top-btn" id="ownerBtn" style="display:none" onclick="openOwner()">üëë Y√∂netim</button>
      <button class="top-btn" onclick="doLogout()">üö™ √áƒ±kƒ±≈ü</button>
    </div>
    <div class="top-fade-r"></div>
  </div>
  <div class="side-panel">
    <div class="ps">
      <div class="ps-title">üìà ƒ∞lerleme</div>
      <div style="font-size:11px;font-weight:700">Seviye <span id="sLevel">1</span> <span id="sLevelName" style="font-size:10px;color:rgba(200,240,255,.38)">Acemi</span></div>
      <div class="xp-bar-wrap"><div class="xp-bar-fill" id="xpBar" style="width:0%"></div></div>
      <div class="xp-label" id="xpLabel">0 / 100 XP</div>
    </div>
    <div class="ps">
      <div class="ps-title">üå§ Durum</div>
      <div class="weather-row"><span style="font-size:18px" id="wIcon">‚òÄÔ∏è</span><div><div style="font-size:11px;font-weight:700" id="wName">G√ºne≈üli</div><div id="wDesc" style="font-size:10px;color:rgba(200,240,255,.38)">Balƒ±klar mutlu</div></div></div>
    </div>
    <div class="ps">
      <div class="ps-title">üê† Balƒ±klarƒ±m (<span id="sFishCount">0</span>)</div>
      <div id="sFishList"><div class="no-content">Hen√ºz balƒ±k yok</div></div>
    </div>
    <div class="ps">
      <div class="ps-title">üèÖ Rozetlerim</div>
      <div id="sBadges"><div class="no-content">Hen√ºz rozet yok</div></div>
    </div>
    <div class="ps" style="font-size:10px;color:rgba(200,240,255,.3);line-height:1.85">
      <div class="ps-title">üí° ƒ∞pu√ßlarƒ±</div>
      üë§ Profil resmine tƒ±kla ‚Üí profil<br>üåæ Balƒ±klara tƒ±kla ‚Üí besle<br>üìã G√∂revleri tamamla ‚Üí coin<br>‚≠ê Seviye atla ‚Üí yeni balƒ±klar
    </div>
  </div>
</div>
<div class="overlay" id="questOverlay" onclick="oClick(event,'questOverlay')">
  <div class="modal" id="questModal">
    <div class="modal-hdr"><h2 style="color:var(--gold)">üìã G√ñREVLER & HEDƒ∞YELER</h2><button class="modal-x" onclick="closeM('questOverlay')">‚úï</button></div>
    <div class="modal-body">
      <div id="giftSection" style="display:none"></div>
      <div class="sec-title" style="margin-top:2px">G√úNL√úK G√ñREVLER</div>
      <div id="questList"></div>
      <div class="quest-timer" id="questTimer"></div>
    </div>
  </div>
</div>
<div class="overlay" id="shopOverlay" onclick="oClick(event,'shopOverlay')">
  <div class="modal" id="shopModal">
    <div class="modal-hdr"><h2 style="color:var(--accent)">üè™ D√úKKAN</h2><div class="shop-coins">üí∞ <span id="shopCoins">0</span></div><button class="modal-x" onclick="closeM('shopOverlay')">‚úï</button></div>
    <div class="shop-cats">
      <button class="cat-btn active" onclick="setCat('fish')">üê† Balƒ±klar</button>
      <button class="cat-btn" onclick="setCat('decor')">ü™∏ Dekorlar</button>
      <button class="cat-btn" onclick="setCat('special')">‚ú® √ñzel</button>
    </div>
    <div class="modal-body"><div class="shop-grid" id="shopGrid"></div></div>
  </div>
</div>
<div class="overlay" id="profileOverlay" onclick="oClick(event,'profileOverlay')">
  <div class="modal" id="profileModal">
    <div class="modal-hdr"><h2 style="color:var(--accent)">üë§ PROFƒ∞L</h2><button class="modal-x" onclick="closeM('profileOverlay')">‚úï</button></div>
    <div class="modal-body" id="profileBody"></div>
  </div>
</div>
<div class="overlay" id="ownerOverlay" onclick="oClick(event,'ownerOverlay')">
  <div class="modal" id="ownerModal">
    <div class="modal-hdr"><h2 style="color:var(--gold)">üëë KURUCU PANELƒ∞</h2><button class="modal-x" onclick="closeM('ownerOverlay')">‚úï</button></div>
    <div class="modal-body">
      <div class="owner-tabs">
        <button class="owner-tab active" onclick="oTab('badge')">üèÖ Rozet</button>
        <button class="owner-tab" onclick="oTab('coin')">üí∞ Para</button>
        <button class="owner-tab" onclick="oTab('item')">üéÅ Item</button>
      </div>
      <div id="ownerContent"></div>
    </div>
  </div>
</div>
<script>
const OWN_U="efeiswat",OWN_P="osinefe17";
const AV={
  nemo:`./av_nemo.png`,
  shark:`./av_shark.png`,
  puffer:`./av_puffer.png`,
  jellyfish:`./av_jelly.png`,
  seahorse:`./av_seahorse.png`,
  dolphin:`./av_dolphin.png`,
  founder:`./av_founder.png`
};
const LVL=[
  {l:1,n:"Acemi Akvaryumcu",xp:0},{l:2,n:"Balƒ±k Dostu",xp:100},
  {l:3,n:"Deniz Ka≈üifi",xp:250},{l:4,n:"Akvaryum Ustasƒ±",xp:500},
  {l:5,n:"Derin Deniz Uzmanƒ±",xp:900},{l:6,n:"Okyanus Efendisi",xp:1400},
  {l:7,n:"Efsane Akvaryumcu",xp:2000},
];
const QD=[
  {id:"feed5",  ico:"üåæ",nm:"Yemek Vakti",   ds:"5 kez besle",       gl:5,  rw:50, st:"fc"},
  {id:"feed10", ico:"üçñ",nm:"Balƒ±k A≈ü√ßƒ±sƒ±",  ds:"10 kez besle",      gl:10, rw:120,st:"fc"},
  {id:"buy1",   ico:"üêü",nm:"Yeni Arkada≈ü",  ds:"1 balƒ±k al",        gl:1,  rw:80, st:"bc"},
  {id:"buy3",   ico:"üê†",nm:"Koleksiyon",     ds:"3 balƒ±k al",        gl:3,  rw:150,st:"bc"},
  {id:"decor1", ico:"ü™∏",nm:"Dekorat√∂r",      ds:"1 dekor al",        gl:1,  rw:60, st:"dc"},
  {id:"decor3", ico:"üè∞",nm:"Usta Dekorat√∂r", ds:"3 dekor al",        gl:3,  rw:110,st:"dc"},
  {id:"login",  ico:"üìÖ",nm:"G√ºnl√ºk Giri≈ü",  ds:"Bug√ºn giri≈ü yap",   gl:1,  rw:30, st:"lc"},
  {id:"coins",  ico:"üí∞",nm:"Para Biriktir",  ds:"500 coin biriktir", gl:500,rw:100,st:"cn"},
  {id:"fish5",  ico:"üê°",nm:"Balƒ±k Yuvasƒ±",   ds:"5 balƒ±ƒüa sahip ol", gl:5,  rw:130,st:"fsh"},
  {id:"lvl2",   ico:"‚≠ê",nm:"Seviye Atla",    ds:"Seviye 2 ol",       gl:2,  rw:200,st:"lvl"},
];
const FISH=[
  {id:"normal",  e:"üêü",nm:"Sƒ±radan Balƒ±k",  ds:"Temel, sakin.",      sp:"Orta",     pr:30, rar:"",   ml:1},
  {id:"tropical",e:"üê†",nm:"Tropik Balƒ±k",   ds:"Renkli, hareketli.", sp:"Hƒ±zlƒ±",    pr:50, rar:"",   ml:1},
  {id:"puffer",  e:"üê°",nm:"Balon Balƒ±k",    ds:"≈ûi≈üman, sevimli.",   sp:"Yava≈ü",    pr:80, rar:"",   ml:2},
  {id:"crab",    e:"ü¶Ä",nm:"Yenge√ß",         ds:"Zikzak hareket.",    sp:"Yava≈ü",    pr:90, rar:"",   ml:2},
  {id:"octopus", e:"üêô",nm:"Ahtapot",        ds:"8 kollu, garip.",    sp:"Orta",     pr:150,rar:"rare",ml:3},
  {id:"turtle",  e:"üê¢",nm:"Kaplumbaƒüa",     ds:"Huzurlu, sakin.",    sp:"√áok Yava≈ü",pr:180,rar:"rare",ml:3},
  {id:"lobster", e:"ü¶û",nm:"Istakoz",        ds:"Prestijli.",         sp:"Yava≈ü",    pr:220,rar:"rare",ml:4},
  {id:"shark",   e:"ü¶à",nm:"K√∂pekbalƒ±ƒüƒ±",    ds:"G√º√ßl√º, agresif.",    sp:"√áok Hƒ±zlƒ±",pr:200,rar:"rare",ml:4},
  {id:"jellyfish",e:"ü™º",nm:"Denizanasƒ±",    ds:"S√ºr√ºklenerek y√ºzer.",sp:"√áok Yava≈ü",pr:280,rar:"epic",ml:5},
  {id:"whale",   e:"üê≥",nm:"Mini Balina",    ds:"Dev ama sakin.",     sp:"Yava≈ü",    pr:350,rar:"epic",ml:6},
  {id:"dolphin", e:"üê¨",nm:"Yunus",          ds:"Akƒ±llƒ±, hƒ±zlƒ±.",     sp:"√áok Hƒ±zlƒ±",pr:400,rar:"epic",ml:7},
  {id:"blowfish",e:"üê°",nm:"Kirpi Balƒ±ƒüƒ±",   ds:"√ñzel y√ºz√º≈ü.",        sp:"Orta",     pr:120,rar:"",   ml:2},
];
const DECOR=[
  {id:"rock",    e:"ü™®",nm:"Kaya",           pr:20},
  {id:"plant",   e:"üåø",nm:"Su Bitkisi",     pr:30},
  {id:"shell",   e:"üêö",nm:"Deniz Kabuƒüu",  pr:35},
  {id:"star",    e:"‚≠ê",nm:"Deniz Yƒ±ldƒ±zƒ±", pr:40},
  {id:"coral",   e:"ü™∏",nm:"Mercan",         pr:60},
  {id:"anchor",  e:"‚öì",nm:"√áƒ±pa",           pr:80},
  {id:"treasure",e:"üè¥‚Äç‚ò†Ô∏è",nm:"Hazine Sandƒ±ƒüƒ±",pr:120},
  {id:"castle",  e:"üè∞",nm:"Mini Kale",      pr:150},
];
const SPE=[
  {id:"sp_light", e:"üí°",nm:"Renkli I≈üƒ±k",   ds:"Renk efekti.",         pr:300,rar:""},
  {id:"sp_feed",  e:"üåæ",nm:"Otomatik Yem",  ds:"30sn'de bir besler.",  pr:500,rar:"rare"},
  {id:"sp_magnet",e:"üß≤",nm:"Para Mƒ±knatƒ±sƒ±",ds:"2x para kazanƒ±m.",     pr:750,rar:"rare"},
  {id:"sp_storm", e:"‚õàÔ∏è",nm:"Fƒ±rtƒ±na Modu",  ds:"Balƒ±klar hƒ±zlanƒ±r!",   pr:400,rar:"epic"},
  {id:"sp_double",e:"‚ú®",nm:"XP Boost",      ds:"2x XP.",               pr:600,rar:"rare"},
];
const FP={
  normal:{v:1.2,s:.9},tropical:{v:1.8,s:1},puffer:{v:.7,s:1.4},
  crab:{v:.6,s:1},octopus:{v:.9,s:1.3},turtle:{v:.45,s:1.5},
  lobster:{v:.7,s:1.1},shark:{v:3,s:1.7},jellyfish:{v:.4,s:1.3},
  whale:{v:.6,s:2.1},dolphin:{v:3.5,s:1.3},blowfish:{v:1,s:1.2},
};
const BADGES=[
  {id:"first_fish",ico:"üêü",nm:"ƒ∞lk Adƒ±m",      ds:"ƒ∞lk balƒ±ƒüƒ±nƒ± koydun!",    auto:true},
  {id:"beta",      ico:"üåä",nm:"Akvaryum Betasƒ±",ds:"13 balƒ±ƒüa ula≈ütƒ±n!",      auto:true},
  {id:"master",    ico:"üèÜ",nm:"Akvaryum Ustasƒ±",ds:"20 balƒ±ƒüa ula≈ütƒ±n!",      auto:true},
  {id:"collector", ico:"üé¥",nm:"Koleksiyoncu",   ds:"8 farklƒ± t√ºr!",           auto:true},
  {id:"rich",      ico:"üí∞",nm:"Zengin",         ds:"1000 coin biriktirdin!",  auto:true},
  {id:"max_level", ico:"üî±",nm:"Efsane Seviye",  ds:"Maks seviye!",            auto:true},
  {id:"quest_hero",ico:"üìã",nm:"G√∂rev Kahramanƒ±",ds:"10 g√∂rev tamamladƒ±n!",    auto:true},
  {id:"legend",    ico:"‚≠ê",nm:"Efsane",         ds:"Kurucu tarafƒ±ndan.",      auto:false},
  {id:"vip",       ico:"üíé",nm:"VIP",            ds:"Kurucu tarafƒ±ndan.",      auto:false},
  {id:"special",   ico:"üëë",nm:"√ñzel Rozet",     ds:"Kurucu tarafƒ±ndan.",      auto:false},
];
const WX=[
  {ico:"‚òÄÔ∏è",nm:"G√ºne≈üli",   ds:"Balƒ±klar mutlu",    sm:1.0,cm:1.0},
  {ico:"üåßÔ∏è",nm:"Yaƒümurlu",  ds:"Balƒ±klar yava≈ü",    sm:0.7,cm:1.2},
  {ico:"‚õàÔ∏è",nm:"Fƒ±rtƒ±nalƒ±", ds:"√áƒ±lgƒ±n y√ºz√º≈ü!",    sm:1.8,cm:0.8},
  {ico:"‚ùÑÔ∏è",nm:"Karlƒ±",     ds:"Donmu≈ü gibi yava≈ü",sm:0.4,cm:1.5},
  {ico:"üåà",nm:"G√∂kku≈üaƒüƒ±", ds:"Ekstra coin!",      sm:1.1,cm:2.0},
  {ico:"üåô",nm:"Gece",      ds:"Balƒ±klar uyuyor‚Ä¶", sm:0.5,cm:0.7},
];
// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
// CRITICAL: fish positions are stored IN MEMORY only (fishPos)
// localStorage only stores static data (coins, level, etc.)
// This prevents draw() from overwriting purchase data
let me=null,isOwner=false,animId=null,tickId=null,autoFeedId=null,wxId=null;
let curCat="fish",selAv="nemo",curOTab="badge";
let spe={},colorLight=false,storm=false,wx=WX[0];
let fishPos={};  // in-memory fish positions: {fishId: {x,y,vx,vy,dir,ph,hunger}}

// ‚îÄ‚îÄ STORAGE ‚îÄ‚îÄ
const S={
  all:()=>JSON.parse(localStorage.getItem("aqw9_u")||"{}"),
  save:u=>localStorage.setItem("aqw9_u",JSON.stringify(u)),
  get:n=>{const u=S.all();return u[n]||null;},
  set:(n,d)=>{const u=S.all();u[n]=d;S.save(u);},
};

function fresh(){
  return{coins:200,fish:[],decors:[],badges:[],specials:[],fishCtr:0,
    password:"",xp:0,level:1,avatar:"nemo",
    quests:{},qs:{fc:0,bc:0,dc:0,lc:1,cn:200,lvl:1,fsh:0},
    lastQD:"",qDone:0,gifts:[]};
}

// THE FIX: fix() ONLY parses coins/xp/level - never touches fish array positions
function fix(d){
  d.coins = isOwner ? 999999999 : (parseFloat(String(d.coins))||0);
  d.xp    = parseInt(d.xp)||0;
  d.level = parseInt(d.level)||1;
  if(!Array.isArray(d.fish))    d.fish=[];
  if(!Array.isArray(d.decors))  d.decors=[];
  if(!Array.isArray(d.badges))  d.badges=[];
  if(!Array.isArray(d.specials))d.specials=[];
  if(!d.fishCtr)   d.fishCtr=0;
  if(!d.avatar)    d.avatar="nemo";
  if(!d.quests)    d.quests={};
  if(!d.qDone)     d.qDone=0;
  if(!Array.isArray(d.gifts))d.gifts=[];
  if(!d.qs)d.qs={fc:0,bc:0,dc:0,lc:1,cn:200,lvl:1,fsh:0};
  return d;
}

// Sync fishPos from stored fish array
function loadFishPos(d){
  fishPos={};
  const W=CV?CV.width:800, H=CV?CV.height:600;
  d.fish.forEach(f=>{
    if(fishPos[f.id])return; // already have position
    const fp=FP[f.type]||FP.normal;
    fishPos[f.id]={
      x:120+Math.random()*(W-240),
      y:100+Math.random()*(H-240),
      vx:(Math.random()-.5)*fp.v*2,
      vy:(Math.random()-.5)*.4,
      dir:Math.random()>.5?1:-1,
      ph:Math.random()*Math.PI*2,
      hunger:f.hunger||100
    };
  });
}

// Save hunger back to fish array before persisting
function syncHunger(d){
  d.fish.forEach(f=>{
    if(fishPos[f.id])f.hunger=fishPos[f.id].hunger;
  });
}

function today(){const n=new Date();return`${n.getFullYear()}-${n.getMonth()}-${n.getDate()}`;}

function initQ(d){
  if(d.lastQD!==today()){
    const s=[...QD].sort(()=>Math.random()-.5).slice(0,5);
    d.quests={};s.forEach(q=>{d.quests[q.id]={prog:0,claimed:false};});
    d.lastQD=today();d.qs.fc=0;d.qs.bc=0;d.qs.dc=0;d.qs.lc=1;
  }else{d.qs.lc=Math.max(1,d.qs.lc||0);}
  return d;
}

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ
function switchTab(t){
  document.querySelectorAll(".tab-btn").forEach((b,i)=>b.classList.toggle("active",i===(t==="login"?0:1)));
  document.getElementById("loginForm").style.display=t==="login"?"":"none";
  document.getElementById("registerForm").style.display=t==="register"?"":"none";
  document.getElementById("founderForm").style.display="none";
  setMsg("");
}
function showFounder(){document.getElementById("loginForm").style.display="none";document.getElementById("founderForm").style.display="";}
function hideFounder(){document.getElementById("loginForm").style.display="";document.getElementById("founderForm").style.display="none";}
function setMsg(t,ok){const e=document.getElementById("authMsg");e.textContent=t;e.className="auth-msg "+(ok?"ok":"err");}
function pickAv(el){document.querySelectorAll(".av-option").forEach(a=>a.classList.remove("selected"));el.classList.add("selected");selAv=el.dataset.av;}

function doLogin(){
  const un=document.getElementById("lUser").value.trim();
  const pw=document.getElementById("lPass").value;
  if(!un||!pw)return setMsg("T√ºm alanlarƒ± doldur!");
  const d=S.get(un);
  if(!d)return setMsg("Kullanƒ±cƒ± bulunamadƒ±!");
  if(d.password!==btoa(pw))return setMsg("≈ûifre yanlƒ±≈ü!");
  startGame(un,false);
}
function doFounderLogin(){
  const pw=document.getElementById("fPass").value;
  if(pw!==OWN_P)return setMsg("Yanlƒ±≈ü ≈üifre!");
  let d=S.get(OWN_U)||fresh();d=fix(d);d.avatar="founder";
  S.set(OWN_U,d);startGame(OWN_U,true);
}
function doRegister(){
  const un=document.getElementById("rUser").value.trim();
  const pw=document.getElementById("rPass").value;
  const p2=document.getElementById("rPass2").value;
  if(!un||!pw)return setMsg("T√ºm alanlarƒ± doldur!");
  if(un===OWN_U)return setMsg("Bu kullanƒ±cƒ± adƒ± alƒ±nmƒ±≈ü!");
  if(pw!==p2)return setMsg("≈ûifreler e≈üle≈ümiyor!");
  if(un.length<3)return setMsg("En az 3 karakter!");
  if(S.get(un))return setMsg("Bu kullanƒ±cƒ± adƒ± alƒ±nmƒ±≈ü!");
  const d=fresh();d.password=btoa(pw);d.avatar=selAv;
  S.set(un,d);setMsg("Kayƒ±t ba≈üarƒ±lƒ±!",true);
  setTimeout(()=>{switchTab("login");document.getElementById("lUser").value=un;},1400);
}
function doLogout(){
  me=null;isOwner=false;fishPos={};
  cancelAnimationFrame(animId);clearInterval(tickId);clearInterval(autoFeedId);clearInterval(wxId);
  document.getElementById("gameScreen").style.display="none";
  document.getElementById("authScreen").style.display="flex";
  document.getElementById("lUser").value="";document.getElementById("lPass").value="";
  colorLight=false;storm=false;spe={};
}
// ‚îÄ‚îÄ GAME START ‚îÄ‚îÄ
function startGame(un,owner){
  me=un;isOwner=owner;
  document.getElementById("authScreen").style.display="none";
  document.getElementById("gameScreen").style.display="block";
  let d=S.get(me);d=fix(d);d=initQ(d);
  d.qs.lvl=d.level;d.qs.cn=Math.floor(d.coins);d.qs.fsh=d.fish.length;
  S.set(me,d);
  spe={};(d.specials||[]).forEach(s=>spe[s]=true);
  colorLight=!!spe["sp_light"];storm=!!spe["sp_storm"];
  document.getElementById("tAvatar").src=AV[d.avatar]||AV.nemo;
  document.getElementById("tUser").textContent=me;
  document.getElementById("tOwner").style.display=owner?"":"none";
  document.getElementById("tDev").style.display=owner?"":"none";
  document.getElementById("ownerBtn").style.display=owner?"":"none";
  setupCanvas();
  loadFishPos(d);
  runLoop();
  if(d.gifts&&d.gifts.length>0)setTimeout(openQuests,900);
  tickId=setInterval(()=>{
    let d=S.get(me);d=fix(d);
    // apply hunger from memory
    Object.keys(fishPos).forEach(id=>{fishPos[id].hunger=Math.max(0,(fishPos[id].hunger||100)-4);});
    if(!isOwner){
      const cm=wx.cm*(spe["sp_magnet"]?2:1);
      const xm=spe["sp_double"]?2:1;
      d.coins=Math.floor(d.coins+Math.max(1,d.fish.length)*2*cm);
      const xpg=Math.max(1,Math.floor(d.fish.length*.5))*xm;
      const ol=d.level;d.xp+=xpg;
      for(let i=LVL.length-1;i>=0;i--){if(d.xp>=LVL[i].xp){d.level=LVL[i].l;break;}}
      if(d.level>ol){showLvlUp(d.level);d.qs.lvl=d.level;}
      d.qs.cn=Math.floor(d.coins);d.qs.fsh=d.fish.length;
    }
    syncHunger(d);S.set(me,d);chkBadges(d);syncQ(d);updateUI();
  },8000);
  wxId=setInterval(()=>{wx=WX[Math.floor(Math.random()*WX.length)];setWx();notif(`${wx.ico} Hava: ${wx.nm}!`);},60000);
  if(spe["sp_feed"])startAutoFeed();
  updateUI();setWx();
}

function startAutoFeed(){
  clearInterval(autoFeedId);
  autoFeedId=setInterval(()=>{
    Object.keys(fishPos).forEach(id=>{fishPos[id].hunger=Math.min(100,(fishPos[id].hunger||0)+25);});
    let d=S.get(me);d=fix(d);syncHunger(d);S.set(me,d);updateUI();notif("üåæ Otomatik yem!");
  },30000);
}
function setWx(){
  document.getElementById("wIcon").textContent=wx.ico;
  document.getElementById("wName").textContent=wx.nm;
  document.getElementById("wDesc").textContent=wx.ds;
}

// ‚îÄ‚îÄ CANVAS ‚îÄ‚îÄ
const CV=document.getElementById("aquariumCanvas");
const cx=CV.getContext("2d");
let bb=[];
function setupCanvas(){resize();window.addEventListener("resize",resize);CV.addEventListener("click",onCVClick);bb=Array.from({length:32},()=>nb(true));}
function resize(){const sp=window.innerWidth>680?238:0;CV.width=window.innerWidth-sp;CV.height=window.innerHeight;}
function nb(rand){return{x:Math.random()*(CV.width||800),y:rand?Math.random()*(CV.height||600):(CV.height||600)+10,r:Math.random()*5+2,sp:Math.random()*.5+.25,wo:Math.random()*Math.PI*2};}
function runLoop(){function loop(ts){draw(ts);animId=requestAnimationFrame(loop);}animId=requestAnimationFrame(loop);}

function draw(ts){
  const W=CV.width,H=CV.height;
  cx.clearRect(0,0,W,H);
  const base=wx.nm==="Gece"?"#000508":wx.nm==="Karlƒ±"?"#051525":"#020e1f";
  const bg=cx.createLinearGradient(0,0,0,H);
  bg.addColorStop(0,base);bg.addColorStop(.55,"#031e42");bg.addColorStop(1,"#010810");
  cx.fillStyle=bg;cx.fillRect(0,0,W,H);
  if(wx.nm==="Karlƒ±"){cx.fillStyle="rgba(200,230,255,.25)";cx.fillRect(0,0,W,H);}
  if(colorLight){const h=(ts/28)%360;const lg=cx.createRadialGradient(W/2,H/2,0,W/2,H/2,W*.75);lg.addColorStop(0,`hsla(${h},100%,55%,.04)`);lg.addColorStop(1,"transparent");cx.fillStyle=lg;cx.fillRect(0,0,W,H);}
  for(let i=0;i<5;i++){const rx=W/5*i+W/10;const rg=cx.createLinearGradient(rx,0,rx+40,H*.7);rg.addColorStop(0,"rgba(0,212,255,.037)");rg.addColorStop(1,"transparent");cx.fillStyle=rg;cx.beginPath();cx.moveTo(rx-20,0);cx.lineTo(rx+22,0);cx.lineTo(rx+70,H*.7);cx.lineTo(rx-20,H*.7);cx.fill();}
  const sg=cx.createLinearGradient(0,H-65,0,H);sg.addColorStop(0,"rgba(160,120,65,0)");sg.addColorStop(.35,"rgba(145,105,50,.35)");sg.addColorStop(1,"rgba(125,90,35,.6)");cx.fillStyle=sg;cx.fillRect(0,H-65,W,65);
  const bspd=wx.nm==="Fƒ±rtƒ±nalƒ±"?3:1;
  bb.forEach(b=>{b.y-=b.sp*bspd;b.wo+=.02;b.x+=Math.sin(b.wo)*.35;if(b.y<-10)Object.assign(b,nb(false));cx.beginPath();cx.arc(b.x,b.y,b.r,0,Math.PI*2);cx.strokeStyle=`rgba(0,212,255,${.1+Math.sin(ts/600)*.04})`;cx.lineWidth=1;cx.stroke();cx.fillStyle="rgba(100,220,255,.03)";cx.fill();});
  // Read fish data from storage but use positions from memory
  const d=S.get(me);if(!d)return;
  cx.textAlign="center";cx.textBaseline="middle";
  (d.decors||[]).forEach(dc=>{cx.font=`${dc.sz||28}px serif`;cx.fillText(dc.e||dc.emoji,dc.x,dc.y);});
  const ws=wx.sm,sm=storm?2.2:1;
  (d.fish||[]).forEach(f=>{
    if(!fishPos[f.id])return;
    const pos=fishPos[f.id];
    const fp=FP[f.type]||FP.normal;
    pos.x+=pos.vx*sm*ws; pos.y+=pos.vy*sm*ws+Math.sin(ts/480+pos.ph)*.35;
    if(pos.x<35){pos.vx=Math.abs(pos.vx);pos.dir=1;} if(pos.x>W-35){pos.vx=-Math.abs(pos.vx);pos.dir=-1;}
    if(pos.y<55){pos.vy=Math.abs(pos.vy)*.5;} if(pos.y>H-85){pos.vy=-Math.abs(pos.vy)*.5;}
    const fd=FISH.find(x=>x.id===f.type)||FISH[0];
    const sz=fp.s*26;
    cx.save();cx.translate(pos.x,pos.y);cx.scale(pos.dir||1,1);
    const h=pos.hunger||0;
    if(h<30){cx.shadowColor="rgba(255,60,60,.9)";cx.shadowBlur=16;}
    else if(h<60){cx.shadowColor="rgba(255,180,0,.5)";cx.shadowBlur=8;}
    cx.font=`${sz}px serif`;cx.textAlign="center";cx.textBaseline="middle";cx.fillText(fd.e,0,0);
    cx.restore();
    cx.fillStyle="rgba(200,240,255,.55)";cx.font="9px Quicksand,sans-serif";cx.textAlign="center";
    cx.fillText(f.name,pos.x,pos.y-sz/2-5);
  });
  // NO S.set here! draw() never writes to storage
}

function onCVClick(e){
  const mods=["shopOverlay","questOverlay","ownerOverlay","profileOverlay"];
  if(mods.some(id=>document.getElementById(id).classList.contains("open")))return;
  const r=CV.getBoundingClientRect(),x=e.clientX-r.left,y=e.clientY-r.top;
  const pt=document.createElement("div");pt.className="feed-pt";pt.textContent="üåæ";
  pt.style.left=e.clientX+"px";pt.style.top=e.clientY+"px";
  document.body.appendChild(pt);setTimeout(()=>pt.remove(),1000);
  let fed=false;
  Object.values(fishPos).forEach(pos=>{
    if(Math.hypot(pos.x-x,pos.y-y)<95){pos.hunger=Math.min(100,(pos.hunger||0)+30);fed=true;}
  });
  if(fed){
    let d=S.get(me);d=fix(d);
    d.qs.fc=(d.qs.fc||0)+1;
    syncHunger(d);S.set(me,d);syncQ(d);updateUI();notif("üåæ Balƒ±k beslendi!");
  }
}
// ‚îÄ‚îÄ MODAL HELPERS ‚îÄ‚îÄ
function openM(id){document.getElementById(id).classList.add("open");}
function closeM(id){document.getElementById(id).classList.remove("open");}
function oClick(e,id){if(e.target===document.getElementById(id))closeM(id);}

// ‚îÄ‚îÄ PROFILE ‚îÄ‚îÄ
function openProfile(){
  let d=S.get(me);d=fix(d);
  const li=getLvl(d.xp);
  document.getElementById("profileBody").innerHTML=`
    <img class="profile-av-big" src="${AV[d.avatar]||AV.nemo}" alt>
    <div class="profile-username">${me}</div>
    <div class="profile-level">${isOwner?"üëë Kurucu":li.cur.n}</div>
    <div class="profile-stats">
      <div class="stat-box"><div class="stat-val">${isOwner?"‚àû":Math.floor(d.coins)}</div><div class="stat-lbl">üí∞ Coin</div></div>
      <div class="stat-box"><div class="stat-val">${isOwner?"MAX":d.level}</div><div class="stat-lbl">‚≠ê Seviye</div></div>
      <div class="stat-box"><div class="stat-val">${d.fish.length}</div><div class="stat-lbl">üê† Balƒ±k</div></div>
      <div class="stat-box"><div class="stat-val">${d.qDone||0}</div><div class="stat-lbl">üìã G√∂rev</div></div>
    </div>
    <div class="profile-sec">üèÖ ROZETLER</div>
    <div class="profile-badges">${
      !d.badges||d.badges.length===0
        ?'<div class="no-content">Hen√ºz rozet yok</div>'
        :d.badges.map(bid=>{const b=BADGES.find(x=>x.id===bid);return b?`<div class="pb-item">${b.ico}<span>${b.nm}</span></div>`:""}).join("")
    }</div>`;
  openM("profileOverlay");
}

// ‚îÄ‚îÄ QUESTS ‚îÄ‚îÄ
function syncQ(d){
  let ch=false;
  Object.keys(d.quests).forEach(qid=>{
    const qd=QD.find(x=>x.id===qid);if(!qd)return;
    const q=d.quests[qid];if(q.claimed)return;
    const val=d.qs[qd.st]||0;
    const prog=Math.min(qd.gl,val);
    if(prog!==q.prog){q.prog=prog;ch=true;}
  });
  if(ch)S.set(me,d);
}

function openQuests(){
  let d=S.get(me);d=fix(d);syncQ(d);
  const gs=document.getElementById("giftSection");
  if(d.gifts&&d.gifts.length>0){
    gs.style.display="block";
    gs.innerHTML=`<div class="sec-title">üéÅ Y√ñNETƒ∞Cƒ∞ HEDƒ∞YELERƒ∞</div>`+
      d.gifts.map((g,i)=>`
        <div class="gift-card">
          <div class="gift-icon">üéÅ</div>
          <div class="gift-info">
            <div class="gift-title">üëë <b>${OWN_U}</b> size hediye g√∂nderdi!</div>
            <div class="gift-msg">${g.message}</div>
          </div>
          <button class="gift-claim-btn" onclick="claimGift(${i})">‚úì Aldƒ±m!</button>
        </div>`).join("");
  }else{gs.style.display="none";gs.innerHTML="";}
  const el=document.getElementById("questList");el.innerHTML="";
  Object.keys(d.quests).forEach(qid=>{
    const qd=QD.find(x=>x.id===qid);if(!qd)return;
    const q=d.quests[qid];
    const pct=Math.min(100,(q.prog/qd.gl)*100);
    const done=q.prog>=qd.gl;
    const c=document.createElement("div");c.className="quest-card"+(q.claimed?" claimed":"");
    c.innerHTML=`
      <span class="quest-icon">${qd.ico}</span>
      <div class="quest-info">
        <div class="quest-name">${qd.nm}</div>
        <div class="quest-desc">${qd.ds}</div>
        <div class="quest-prog-wrap"><div class="quest-prog-fill" style="width:${pct}%"></div></div>
        <div class="quest-prog-text">${q.prog} / ${qd.gl}</div>
        ${done&&!q.claimed?`<button class="quest-claim-btn" onclick="claimQ('${qid}')">üí∞ +${qd.rw} Al!</button>`:""}
        ${q.claimed?`<div class="quest-done-lbl">‚úì Tamamlandƒ±</div>`:""}
      </div>
      <div class="quest-reward">üí∞ ${qd.rw}</div>`;
    el.appendChild(c);
  });
  const now=new Date(),mid=new Date(now);mid.setHours(24,0,0,0);
  const diff=mid-now,h=Math.floor(diff/3600000),m=Math.floor((diff%3600000)/60000);
  document.getElementById("questTimer").textContent=`üïê Yenilenmesine: ${h}s ${m}dk`;
  openM("questOverlay");
}

function claimGift(i){
  let d=S.get(me);d=fix(d);
  if(!d.gifts||i>=d.gifts.length)return;
  const g=d.gifts.splice(i,1)[0];
  if(g.type==="coin")d.coins=Math.floor(d.coins+g.amount);
  if(g.type==="badge"&&!d.badges.includes(g.badgeId))d.badges.push(g.badgeId);
  if(g.type==="item"&&!d.specials.includes(g.itemId)){
    d.specials.push(g.itemId);spe[g.itemId]=true;
    if(g.itemId==="sp_light")colorLight=true;
    if(g.itemId==="sp_storm")storm=true;
    if(g.itemId==="sp_feed")startAutoFeed();
  }
  S.set(me,d);updateUI();notif("üéÅ Hediye alƒ±ndƒ±!");openQuests();
}

function claimQ(qid){
  let d=S.get(me);d=fix(d);
  const qd=QD.find(x=>x.id===qid);if(!qd)return;
  const q=d.quests[qid];
  if(!q||q.claimed||q.prog<qd.gl)return;
  q.claimed=true;
  d.coins=Math.floor(d.coins+qd.rw);
  d.qDone=(d.qDone||0)+1;
  d.qs.cn=Math.floor(d.coins);
  S.set(me,d);chkBadges(d);updateUI();notif(`üéâ +${qd.rw} coin!`);openQuests();
}
// ‚îÄ‚îÄ SHOP ‚îÄ‚îÄ
function openShop(){renderShop();openM("shopOverlay");}
function setCat(c){
  curCat=c;
  document.querySelectorAll(".cat-btn").forEach((b,i)=>b.classList.toggle("active",["fish","decor","special"][i]===c));
  renderShop();
}

function renderShop(){
  // Always read fresh data from storage
  let d=S.get(me);d=fix(d);
  const coins=isOwner?999999999:d.coins;
  const ul=isOwner?99:d.level;
  document.getElementById("shopCoins").textContent=isOwner?"‚àû":Math.floor(coins);

  let items=[];
  if(curCat==="fish")items=FISH;
  else if(curCat==="decor")items=DECOR;
  else items=SPE;

  document.getElementById("shopGrid").innerHTML=items.map(item=>{
    const owned   = curCat==="special" && (d.specials||[]).includes(item.id);
    const locked  = curCat==="fish"    && (item.ml||1)>ul;
    const canAfford = isOwner || coins>=item.pr;
    const canBuy  = !owned && !locked;

    const speedT = item.sp ? `<div class="sc-speed">‚ö° ${item.sp}</div>` : "";
    const lockT  = locked  ? `<div class="sc-req">üîí Seviye ${item.ml}</div>` : "";
    const descT  = item.ds ? `<div class="sc-desc">${item.ds}</div>` : "";
    const priceS = locked  ? `Lv.${item.ml}` : isOwner?"‚àû":`üí∞ ${item.pr}`;

    let btnCls  = "card-btn";
    let btnTxt  = "Satƒ±n Al";
    let onclk   = "";

    if(owned){
      btnCls += " owned";
      btnTxt  = "‚úì Aktif";
    } else if(locked){
      btnCls += " cant";
      btnTxt  = "üîí Kilitli";
    } else if(!canAfford){
      btnCls += " cant";
      btnTxt  = `‚ùå ${item.pr} gerekli`;
    } else {
      // Can buy!
      if(curCat==="fish")        onclk=`buyFish('${item.id}')`;
      else if(curCat==="decor")  onclk=`buyDecor('${item.id}')`;
      else                       onclk=`buySpecial('${item.id}')`;
    }

    const btnHtml = onclk
      ? `<button class="${btnCls}" onclick="${onclk}">${btnTxt}</button>`
      : `<button class="${btnCls}" disabled>${btnTxt}</button>`;

    return `<div class="shop-card ${item.rar||""} ${locked?"locked":""}">
      <span class="sc-icon">${item.e}</span>
      <div class="sc-name">${item.nm}</div>
      ${descT}${speedT}${lockT}
      <div class="sc-price">${priceS}</div>
      ${btnHtml}
    </div>`;
  }).join("");
}

// ‚îÄ‚îÄ BUY FUNCTIONS - THE CRITICAL FIX ‚îÄ‚îÄ
// Always read fresh from storage, deduct, save, then reload
function buyFish(type){
  // Step 1: read fresh
  let d=S.get(me);d=fix(d);
  // Step 2: find item
  const item=FISH.find(x=>x.id===type);
  if(!item)return notif("‚ùå Balƒ±k bulunamadƒ±!");
  // Step 3: check level
  const ul=isOwner?99:d.level;
  if((item.ml||1)>ul)return notif(`üîí Seviye ${item.ml} gerekli!`);
  // Step 4: check coins
  if(!isOwner&&d.coins<item.pr)return notif(`‚ùå Para yok! Gereken:${item.pr} Sahip:${Math.floor(d.coins)}`);
  // Step 5: deduct coins
  if(!isOwner)d.coins=Math.floor(d.coins-item.pr);
  // Step 6: add fish to data
  const fp=FP[type]||FP.normal;
  const names=["Nemo","Dori","Splash","Goldie","Finley","Marina","Bubbles","Jaws","Wave","Coral","Lucky","Storm","Nova","Pearl","Finn","Mavi"];
  d.fishCtr=(d.fishCtr||0)+1;
  const fid=d.fishCtr;
  d.fish.push({id:fid,type,name:names[Math.floor(Math.random()*names.length)]+fid});
  // Step 7: update quest stats
  d.qs.bc=(d.qs.bc||0)+1;d.qs.fsh=d.fish.length;
  // Step 8: SAVE immediately
  S.set(me,d);
  // Step 9: add position to memory
  const W=CV.width||800,H=CV.height||600;
  fishPos[fid]={x:120+Math.random()*(W-240),y:100+Math.random()*(H-240),vx:(Math.random()-.5)*fp.v*2,vy:(Math.random()-.5)*.4,dir:Math.random()>.5?1:-1,ph:Math.random()*Math.PI*2,hunger:100};
  // Step 10: update UI
  chkBadges(d);syncQ(d);updateUI();
  notif(`${item.e} ${item.nm} eklendi! üí∞${Math.floor(d.coins)} kaldƒ±`);
  renderShop();
}

function buyDecor(type){
  let d=S.get(me);d=fix(d);
  const item=DECOR.find(x=>x.id===type);
  if(!item)return;
  if(!isOwner&&d.coins<item.pr)return notif(`‚ùå Para yok! Gereken:${item.pr} Sahip:${Math.floor(d.coins)}`);
  if(!isOwner)d.coins=Math.floor(d.coins-item.pr);
  const W=CV.width||800,H=CV.height||600;
  d.decors.push({type,e:item.e,x:60+Math.random()*(W-120),y:H-42-Math.random()*22,sz:24+Math.random()*10});
  d.qs.dc=(d.qs.dc||0)+1;
  S.set(me,d);syncQ(d);updateUI();
  notif(`${item.e} ${item.nm} eklendi!`);renderShop();
}

function buySpecial(type){
  let d=S.get(me);d=fix(d);
  const item=SPE.find(x=>x.id===type);
  if(!item)return;
  if((d.specials||[]).includes(type))return notif("Zaten sahipsin!");
  if(!isOwner&&d.coins<item.pr)return notif(`‚ùå Para yok! Gereken:${item.pr} Sahip:${Math.floor(d.coins)}`);
  if(!isOwner)d.coins=Math.floor(d.coins-item.pr);
  if(!d.specials)d.specials=[];
  d.specials.push(type);
  S.set(me,d);
  spe[type]=true;
  if(type==="sp_feed")startAutoFeed();
  if(type==="sp_light")colorLight=true;
  if(type==="sp_storm")storm=true;
  updateUI();notif(`${item.e} ${item.nm} aktif!`);renderShop();
}
// ‚îÄ‚îÄ LEVEL ‚îÄ‚îÄ
function getLvl(xp){
  let cur=LVL[0];
  for(let i=0;i<LVL.length;i++){if(xp>=LVL[i].xp)cur=LVL[i];}
  return{cur,next:LVL.find(l=>l.xp>xp)};
}
function showLvlUp(lvl){
  const li=LVL.find(l=>l.l===lvl)||LVL[LVL.length-1];
  const el=document.createElement("div");el.className="levelup";
  el.innerHTML=`<div style="font-family:'Orbitron',monospace;font-size:11px;color:var(--accent2);letter-spacing:3px;margin-bottom:12px">‚≠ê SEVƒ∞YE ATLADIN!</div>
    <span class="bp-icon">üéâ</span>
    <div class="bp-green">Seviye ${lvl}</div>
    <div class="bp-desc">${li.n}</div>
    <button class="popup-btn-g" onclick="this.parentElement.remove();renderShop()">Harika!</button>`;
  document.body.appendChild(el);
}

// ‚îÄ‚îÄ BADGES ‚îÄ‚îÄ
function chkBadges(d){
  const n=d.fish.length,b=d.badges;let got=null;
  if(n>=1  &&!b.includes("first_fish")){b.push("first_fish");got=BADGES.find(x=>x.id==="first_fish");}
  if(n>=13 &&!b.includes("beta"))      {b.push("beta");      got=BADGES.find(x=>x.id==="beta");}
  if(n>=20 &&!b.includes("master"))    {b.push("master");    got=BADGES.find(x=>x.id==="master");}
  if(!isOwner&&d.coins>=1000&&!b.includes("rich")){b.push("rich");got=BADGES.find(x=>x.id==="rich");}
  if(new Set(d.fish.map(f=>f.type)).size>=8&&!b.includes("collector")){b.push("collector");got=BADGES.find(x=>x.id==="collector");}
  if(d.level>=7&&!b.includes("max_level")){b.push("max_level");got=BADGES.find(x=>x.id==="max_level");}
  if((d.qDone||0)>=10&&!b.includes("quest_hero")){b.push("quest_hero");got=BADGES.find(x=>x.id==="quest_hero");}
  if(got){S.set(me,d);showBadge(got);}
}
function showBadge(b){
  const el=document.createElement("div");el.className="badge-popup";
  el.innerHTML=`<div style="font-family:'Orbitron',monospace;font-size:11px;color:var(--gold);letter-spacing:3px;margin-bottom:12px">üéâ ROZET KAZANDIN!</div>
    <span class="bp-icon">${b.ico}</span>
    <div class="bp-gold">${b.nm}</div>
    <div class="bp-desc">${b.ds}</div>
    <button class="popup-btn" onclick="this.parentElement.remove()">Harika!</button>`;
  document.body.appendChild(el);
}

// ‚îÄ‚îÄ OWNER ‚îÄ‚îÄ
let oUsers=[];
function openOwner(){
  oUsers=Object.keys(S.all()).filter(u=>u!==OWN_U);
  oTab("badge");openM("ownerOverlay");
}
function oTab(tab){
  curOTab=tab;
  document.querySelectorAll(".owner-tab").forEach((b,i)=>b.classList.toggle("active",["badge","coin","item"][i]===tab));
  renderOwner();
}
function renderOwner(){
  const el=document.getElementById("ownerContent");
  if(!oUsers.length){el.innerHTML='<div style="color:rgba(200,240,255,.32);font-size:13px;text-align:center;padding:20px">Kayƒ±tlƒ± kullanƒ±cƒ± yok</div>';return;}
  el.innerHTML=oUsers.map(un=>{
    const ud=S.get(un);
    const av=AV[(ud&&ud.avatar)||"nemo"]||AV.nemo;
    const coins=Math.floor((ud&&ud.coins)||0);
    const lvl=(ud&&ud.level)||1;
    const fish=(ud&&ud.fish&&ud.fish.length)||0;
    const top=`<div class="u-row-top"><img class="u-av" src="${av}" alt><div class="u-info"><div class="u-name">${un}</div><div class="u-stats">Lv.${lvl} ¬∑ ${fish} balƒ±k ¬∑ üí∞${coins}</div></div></div>`;
    if(curOTab==="badge"){
      const manual=BADGES.filter(b=>!b.auto);
      return`<div class="u-row">${top}
        <select class="o-select" id="bs_${un}">${manual.map(b=>`<option value="${b.id}">${b.ico} ${b.nm}</option>`).join("")}</select>
        <button class="o-btn o-btn-gold" onclick="sendBadge('${un}')">üèÖ Rozet G√∂nder</button>
      </div>`;
    }
    if(curOTab==="coin")return`<div class="u-row">${top}
      <input class="o-input" id="ca_${un}" type="number" placeholder="Coin miktarƒ±" min="1">
      <button class="o-btn o-btn-gold" onclick="sendCoin('${un}')">üí∞ G√∂nder</button>
    </div>`;
    if(curOTab==="item")return`<div class="u-row">${top}
      <select class="o-select" id="is_${un}">${SPE.map(s=>`<option value="${s.id}">${s.e} ${s.nm}</option>`).join("")}</select>
      <button class="o-btn o-btn-green" onclick="sendItem('${un}')">üéÅ Item G√∂nder</button>
    </div>`;
    return"";
  }).join("");
}

function sendBadge(un){
  const sel=document.getElementById(`bs_${un}`);if(!sel)return;
  const bid=sel.value;const d=S.get(un);if(!d)return;
  if(!d.badges)d.badges=[];
  if(d.badges.includes(bid))return notif("‚ö†Ô∏è Bu rozet zaten var!");
  const bdef=BADGES.find(x=>x.id===bid);
  if(!d.gifts)d.gifts=[];
  d.gifts.push({type:"badge",badgeId:bid,message:`üèÖ <b>${bdef?.ico} ${bdef?.nm}</b> rozeti hediye edildi!`});
  d.badges.push(bid);S.set(un,d);notif(`‚úÖ ${un} kullanƒ±cƒ±sƒ±na rozet g√∂nderildi!`);
}
function sendCoin(un){
  const inp=document.getElementById(`ca_${un}`);if(!inp)return;
  const amount=parseInt(inp.value)||0;
  if(amount<=0)return notif("‚ùå Ge√ßersiz miktar!");
  const d=S.get(un);if(!d)return;
  if(!d.gifts)d.gifts=[];
  d.gifts.push({type:"coin",amount,message:`üí∞ <b>${amount} coin</b> hediye edildi!`});
  d.coins=Math.floor((parseFloat(String(d.coins))||0)+amount);
  S.set(un,d);inp.value="";notif(`‚úÖ ${un} kullanƒ±cƒ±sƒ±na ${amount} coin g√∂nderildi!`);
}
function sendItem(un){
  const sel=document.getElementById(`is_${un}`);if(!sel)return;
  const itemId=sel.value;const d=S.get(un);if(!d)return;
  if((d.specials||[]).includes(itemId))return notif("‚ö†Ô∏è Bu item zaten var!");
  const idef=SPE.find(x=>x.id===itemId);
  if(!d.gifts)d.gifts=[];
  d.gifts.push({type:"item",itemId,message:`${idef?.e} <b>${idef?.nm}</b> √∂zel e≈üyasƒ± hediye edildi!`});
  if(!d.specials)d.specials=[];d.specials.push(itemId);
  S.set(un,d);notif(`‚úÖ ${un} kullanƒ±cƒ±sƒ±na ${idef?.nm} g√∂nderildi!`);
}

// ‚îÄ‚îÄ UI UPDATE ‚îÄ‚îÄ
function updateUI(){
  let d=S.get(me);if(!d)return;d=fix(d);
  const{cur,next}=getLvl(d.xp);
  document.getElementById("tCoins").textContent=isOwner?"‚àû":Math.floor(d.coins);
  document.getElementById("tLevel").textContent=isOwner?"MAX":d.level;
  document.getElementById("sLevel").textContent=isOwner?"MAX":d.level;
  document.getElementById("sLevelName").textContent=isOwner?"Kurucu":cur.n;
  if(next&&!isOwner){
    const p=Math.min(100,((d.xp-cur.xp)/(next.xp-cur.xp))*100);
    document.getElementById("xpBar").style.width=p+"%";
    document.getElementById("xpLabel").textContent=`${d.xp} / ${next.xp} XP`;
  }else{document.getElementById("xpBar").style.width="100%";document.getElementById("xpLabel").textContent="MAX üî±";}
  document.getElementById("sFishCount").textContent=d.fish.length;
  const fl=document.getElementById("sFishList");
  fl.innerHTML=d.fish.length===0?'<div class="no-content">Hen√ºz balƒ±k yok</div>':
    d.fish.map(f=>{
      const pos=fishPos[f.id];
      const h=pos?pos.hunger:100;
      const c=h>60?"#00ff9d":h>30?"#ffaa00":"#ff4444";
      const fd=FISH.find(x=>x.id===f.type)||FISH[0];
      return`<div class="fish-row"><span>${fd.e}</span><span style="flex:1">${f.name}</span><div class="hunger-bar"><div class="hunger-fill" style="width:${h}%;background:${c}"></div></div></div>`;
    }).join("");
  const bs=d.badges||[];
  document.getElementById("sBadges").innerHTML=bs.length===0?'<div class="no-content">Hen√ºz rozet yok</div>':
    bs.map(bid=>{const b=BADGES.find(x=>x.id===bid);return b?`<span class="badge-chip">${b.ico} ${b.nm}</span>`:""}).join("");
}

function notif(text){
  const el=document.createElement("div");el.className="notif";el.textContent=text;
  document.body.appendChild(el);setTimeout(()=>el.remove(),3000);
}

document.addEventListener("keydown",e=>{
  if(e.key!=="Enter")return;
  if(document.getElementById("loginForm").style.display!=="none")doLogin();
  else if(document.getElementById("registerForm").style.display!=="none")doRegister();
  else if(document.getElementById("founderForm").style.display!=="none")doFounderLogin();
});
</script>
</body>
</html>
